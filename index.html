<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REYHANTEX | Royal Fabric Showroom</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Vazirmatn -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;700;800;900&display=swap"
        rel="stylesheet">

    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Vazirmatn', 'sans-serif'],
                    },
                    colors: {
                        reyhan: {
                            green: '#013a34',
                            dark: '#002521',
                            gold: '#d4af37',
                            goldLight: '#f3e5ab',
                        }
                    },
                    backgroundImage: {
                        'gold-gradient': 'linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c)',
                        'green-gradient': 'linear-gradient(to bottom, #013a34, #002521)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-subtle': 'pulseSubtle 2s ease-in-out infinite',
                        'logo-float': 'logoFloat 8s ease-in-out infinite',
                        'glow': 'glow 3s ease-in-out infinite',
                        'shimmer': 'shimmer 2s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        pulseSubtle: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.8' } },
                        logoFloat: { '0%, 100%': { transform: 'translateY(0px) rotate(0deg)' }, '25%': { transform: 'translateY(-15px) rotate(2deg)' }, '50%': { transform: 'translateY(0px) rotate(0deg)' }, '75%': { transform: 'translateY(-8px) rotate(-1deg)' } },
                        glow: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.7' } },
                        shimmer: { '0%': { backgroundPosition: '-500px 0' }, '100%': { backgroundPosition: '500px 0' } },
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: #013a34;
            color: #ffffff;
            overflow-x: hidden;
        }

        .text-gold {
            background: linear-gradient(to bottom, #fcf6ba, #bf953f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .glass-panel {
            background: rgba(1, 58, 52, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #002521;
        }

        ::webkit-scrollbar-thumb {
            background: #d4af37;
            border-radius: 4px;
        }

        .btn-gold {
            background: linear-gradient(135deg, #d4af37, #f3e5ab, #b38728);
            color: #002521;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
        }

        .input-field {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            transition: all 0.3s;
        }

        .input-field:focus {
            border-color: #d4af37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
            outline: none;
        }

        .logo-glow {
            filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.3));
        }

        .logo-image {
            transition: all 0.5s ease;
            object-fit: contain;
        }

        /* Image Upload Styles */
        .image-upload-area {
            border: 2px dashed rgba(212, 175, 55, 0.5);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload-area:hover {
            border-color: rgba(212, 175, 55, 0.8);
            background: rgba(212, 175, 55, 0.05);
        }

        .image-upload-area.dragover {
            border-color: rgba(212, 175, 55, 1);
            background: rgba(212, 175, 55, 0.1);
            transform: scale(1.02);
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .preview-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            transition: all 0.3s;
            cursor: pointer;
        }

        .preview-image:hover {
            transform: scale(1.05);
            border-color: rgba(212, 175, 55, 0.8);
        }

        /* Tag Styles */
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 20px;
            font-size: 12px;
            color: #f3e5ab;
            transition: all 0.2s;
            cursor: pointer;
        }

        .tag:hover {
            background: rgba(212, 175, 55, 0.25);
            border-color: rgba(212, 175, 55, 0.5);
            transform: translateY(-1px);
        }

        .tag.active {
            background: rgba(212, 175, 55, 0.4);
            border-color: #d4af37;
            font-weight: bold;
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .tag-remove:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .tag-input {
            min-width: 120px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 20px;
            padding: 4px 12px;
            color: white;
            font-size: 12px;
        }

        .tag-input:focus {
            outline: none;
            border-color: #d4af37;
        }

        .image-tag-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: #f3e5ab;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            z-index: 10;
            cursor: pointer;
            transition: all 0.2s;
        }

        .image-tag-badge:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.05);
        }

        .image-tags-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            padding: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .image-container:hover .image-tags-overlay {
            opacity: 1;
        }

        .quick-tag-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(212, 175, 55, 0.9);
            color: #002521;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            z-index: 10;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0;
        }

        .image-container:hover .quick-tag-btn {
            opacity: 1;
        }

        .quick-tag-btn:hover {
            background: #d4af37;
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .preview-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }

            .preview-image {
                width: 80px;
                height: 80px;
            }
        }

        @media (max-width: 480px) {
            .preview-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            }

            .preview-image {
                width: 70px;
                height: 70px;
            }
        }
    </style>
</head>

<body class="bg-reyhan-green min-h-screen">

    <div id="app" class="w-full min-h-screen"></div>

    <script>
        /**
         * REYHANTEX FABRIC SHOWROOM - ENHANCED VERSION
         * Features:
         * 1. Simple image opening in new tab
         * 2. Admin panel for uploading images from any device
         * 3. Random image showcase on landing page
         * 4. Enhanced tag management system
         * 5. All Images gallery view
         */

        const CONFIG = {
            password: "123",
            adminPassword: "admin123",
            dbName: "ReyhanTexDB",
            dbVersion: 3,
            logoImage: localStorage.getItem('reyhantex_logo') || 'assets/logo/IMG_20251209_154206_917.jpg'
        };

        // Base fabrics with their images
        const FABRICS = [
            {
                id: 1,
                name: 'ریحانا',
                enName: 'Reyhana',
                price: '$$$',
                image: 'assets/fabric/reyhana/children/1770015701234.png',
                categoryImages: {
                    male: 'assets/fabric/selina/male/1770109219087.png',
                    female: 'assets/fabric/pofaki/female/1770018110135.png',
                    children: 'assets/fabric/pofaki/children/1770112752571.png'
                }
            },
            {
                id: 2,
                name: 'پفکی (ینزی)',
                enName: 'Pofaki (Yenzi)',
                price: '$$$$',
                image: 'assets/fabric/pofaki/children/1770112977067.png',
                categoryImages: {
                    male: 'assets/fabric/selina/male/1770109219087.png',
                    female: 'assets/fabric/pofaki/female/1770018110135.png',
                    children: 'assets/fabric/pofaki/children/1770112752571.png'
                }
            },
            {
                id: 3,
                name: 'سلینا',
                enName: 'Selina',
                price: '$$$$',
                image: 'assets/fabric/selina/male/1770109459483.png',
                categoryImages: {
                    male: 'assets/fabric/selina/male/1770109219087.png',
                    female: 'assets/fabric/pofaki/female/1770018110135.png',
                    children: 'assets/fabric/pofaki/children/1770112752571.png'
                }
            },
            {
                id: 4,
                name: 'پلی استر پنبه',
                enName: 'PoliEsterPanbeh',
                price: '$$$$',
                image: 'assets/fabric/poliEsterPanbeh_U/male/Gemini_Generated_Image_ai9bq2ai9bq2ai9b.png',
                categoryImages: {
                    male: 'assets/fabric/selina/male/1770109219087.png',
                    female: 'assets/fabric/pofaki/female/1770018110135.png',
                    children: 'assets/fabric/pofaki/children/1770112752571.png'
                }
            },
        ];

        const CATEGORIES = [
            {
                id: 'male',
                label: 'آقایـان',
                enLabel: 'Gentlemen',
                desc: 'ساختار و قدرت',
                color: 'bg-blue-900/40',
                border: 'border-blue-500/30',
            },
            {
                id: 'female',
                label: 'بانـوان',
                enLabel: 'Ladies',
                desc: 'شکوه و زیبایی',
                color: 'bg-pink-900/40',
                border: 'border-pink-500/30',
            },
            {
                id: 'children',
                label: 'کـودکان',
                enLabel: 'Little Ones',
                desc: 'لطافت و رویا',
                color: 'bg-purple-900/40',
                border: 'border-purple-500/30',
            },
        ];

        // Gallery images - will be loaded from localStorage with tags
        let GALLERY_IMAGES = {
            reyhana_male: [],
            reyhana_female: [
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 28, 2026, 03_47_37 PM.png', tags: ['ساده', 'ساحلی'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 28, 2026, 03_56_47 PM.png', tags: ['ساده', 'تاپ'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 28, 2026, 04_05_52 PM.png', tags: ['ساده', 'شومیز'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 28, 2026, 04_21_13 PM.png', tags: ['ساده', 'ست', 'تاپ'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 28, 2026, 04_34_23 PM.png', tags: ['ساده', 'ساحلی'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 28, 2026, 04_48_54 PM.png', tags: ['ساده', 'تاپ'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 28, 2026, 04_54_43 PM.png', tags: ['ساده', 'شومیز'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 28, 2026, 05_16_15 PM.png', tags: ['ست', 'تاپ'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 28, 2026, 05_31_05 PM.png', tags: ['ساده', 'ساحلی'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 28, 2026, 05_44_24 PM.png', tags: ['ساده' , 'ساحلی'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 01_00_18 PM.png', tags: ['ست', 'شومیز'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 01_07_00 PM.png', tags: ['ست', 'ساده', 'تیشرت'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 01_09_06 PM.png', tags: ['ساده'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 01_11_10 PM.png', tags: ['ساده'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 10_39_41 AM.png', tags: ['ساده', 'ساحلی'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 10_51_18 AM.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 10_51_28 AM.png', tags: ['ساده', 'ست', 'شومیز'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 10_51_30 AM.png', tags: ['ست', 'تیشرت'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 10_58_39 AM.png', tags: ['ساده'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 11_03_33 AM.png', tags: ['ساده', 'ساحلی'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 11_04_47 AM.png', tags: ['ست', 'تاپ'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 11_07_46 AM.png', tags: ['ست', 'شومیز'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 11_09_06 AM.png', tags: ['ست', 'تیشرت'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 11_14_13 AM.png', tags: ['ساده'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 11_16_50 AM.png', tags: ['ساده'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 11_40_54 AM.png', tags: ['ساده', 'ساحلی'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 11_40_59 AM.png', tags: ['ست', 'تاپ'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 11_41_05 AM.png', tags: ['ست', 'شومیز'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 11_45_50 AM.png', tags: ['ست', 'تیشرت'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 12_44_18 PM.png', tags: ['ساده', 'ساحلی'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 12_49_36 PM.png', tags: ['ساده', 'ساحلی'] },
                { url: 'assets/fabric/reyhana/female/ChatGPT Image Jan 29, 2026, 12_57_26 PM.png', tags: ['ست', 'تاپ'] },
            ],
            reyhana_children: [
                { url: 'assets/fabric/reyhana/children/1770015636848.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/reyhana/children/1770015672874.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/reyhana/children/1770015701234.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/reyhana/children/1770015729556.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/reyhana/children/1770015790133.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/reyhana/children/1770015819565.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/reyhana/children/1770015902789.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/reyhana/children/Gemini_Generated_Image_7h6gic7h6gic7h6g.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/reyhana/children/Gemini_Generated_Image_t2d95kt2d95kt2d9.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/reyhana/children/Gemini_Generated_Image_tl4g8ntl4g8ntl4g.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/reyhana/children/Gemini_Generated_Image_uw4e96uw4e96uw4e.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/reyhana/children/Gemini_Generated_Image_uxyx4huxyx4huxyx.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/reyhana/children/Gemini_Generated_Image_vpzgcuvpzgcuvpzg.png', tags: ['ساده', 'ست'] },
            ],
            pofaki_male: [],
            pofaki_female: [
                { url: 'assets/fabric/pofaki/female/1765890467695.jpg', tags: ['چاپی', 'ساحلی'] },
                { url: 'assets/fabric/pofaki/female/1769515671229.png', tags: ['چاپی', 'ساحلی'] },
                { url: 'assets/fabric/pofaki/female/1770018110135.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/female/1770018306729.png', tags: ['چاپی', 'تیشرت'] },
                { url: 'assets/fabric/pofaki/female/1770018459064.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/female/1770018531854.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/female/1770018604231.png', tags: ['چاپی', 'تیشرت'] },
                { url: 'assets/fabric/pofaki/female/1770019000539.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/female/1770019009600.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/female/1770019015979.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/female/1770019097905.png', tags: ['چاپی', 'تیشرت'] },
                { url: 'assets/fabric/pofaki/female/1770019378929.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/female/1770039550790.png', tags: ['نگینی', 'شومیز'] },
                { url: 'assets/fabric/pofaki/female/1770040588723.png', tags: ['چاپی', 'شومیز'] },
                { url: 'assets/fabric/pofaki/female/1770040773855.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/female/ChatGPT Image Jan 29, 2026, 01_24_26 PM.png', tags: ['ست', 'نگینی', 'تاپ'] },
                { url: 'assets/fabric/pofaki/female/Gemini_Generated_Image_e8l0qte8l0qte8l0.png', tags: ['چاپی', 'ساحلی'] },
                { url: 'assets/fabric/pofaki/female/Gemini_Generated_Image_hh71tchh71tchh71.png', tags: ['چاپی', 'ساحلی'] },
                { url: 'assets/fabric/pofaki/female/Gemini_Generated_Image_ncrt8kncrt8kncrt.png', tags: ['چاپی', 'تیشرت'] },
                { url: 'assets/fabric/pofaki/female/Gemini_Generated_Image_uvdm5xuvdm5xuvdm.png', tags: ['چاپی', 'ساحلی'] },
                { url: 'assets/fabric/pofaki/female/Gemini_Generated_Image_v68zczv68zczv68z.png', tags: ['چاپی'] },
                { url: 'assets/fabric/pofaki/female/Gemini_Generated_Image_xr7tgcxr7tgcxr7t.png', tags: ['چاپی', 'شومیز'] },
                { url: 'assets/fabric/pofaki/female/Gemini_Generated_Image_xup0yjxup0yjxup0.png', tags: ['چاپی', 'ساحلی'] },
                { url: 'assets/fabric/pofaki/female/IMG_20260202_151219.png', tags: ['چاپی', 'ساحلی'] },
                { url: 'assets/fabric/pofaki/female/IMG_20260202_151242.png', tags: ['چاپی', 'ساحلی'] },
                { url: 'assets/fabric/pofaki/female/IMG_20260202_151312.png', tags: ['چاپی', 'ساحلی'] },
                { url: 'assets/fabric/pofaki/female/IMG_20260202_151331.png', tags: ['چاپی', 'ساحلی'] },
                { url: 'assets/fabric/pofaki/female/IMG_20260202_151358.png', tags: ['چاپی', 'ساحلی'] },
                { url: 'assets/fabric/pofaki/female/IMG_20260202_151415.png', tags: ['چاپی', 'ساحلی'] },
                { url: 'assets/fabric/pofaki/female/IMG_20260202_151445.png', tags: ['چاپی', 'ساحلی'] },
                { url: 'assets/fabric/pofaki/female/IMG_20260202_151509.png', tags: ['چاپی', 'ساحلی'] },
                { url: 'assets/fabric/pofaki/female/IMG_20260202_151535.png', tags: ['چاپی', 'ساحلی'] },
            ],
            pofaki_children: [
                { url: 'assets/fabric/pofaki/children/1770110218507.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/children/1770110370256.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/children/1770110482376.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/children/1770110706577.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/children/1770112752571.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/children/1770112977067.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/children/1770113555664.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/children/1770114116695.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/children/1770114208083.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/children/1770114262292.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/children/1770114327122.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/children/1770114379835.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/children/1770114439797.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/children/1770114487477.png', tags: ['چاپی', 'ست'] },
                { url: 'assets/fabric/pofaki/children/1770114543076.png', tags: ['چاپی', 'ست'] },
            ],
            selina_male: [
                { url: 'assets/fabric/selina/male/1770109002011.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/selina/male/1770109219087.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/selina/male/1770109237763.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/selina/male/1770109404605.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/selina/male/1770109459483.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/selina/male/1770109780407.png', tags: ['ساده', 'ست'] },
            ],
            selina_female: [
                { url: 'assets/fabric/selina/female/1765869607872.jpg', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/selina/female/1765891532899.jpg', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/selina/female/1770040351354.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/selina/female/1770040832256.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/selina/female/1770106262449.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/selina/female/1770106289197.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/selina/female/1770106315164.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/selina/female/1770108523837.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/selina/female/1770108637157.png', tags: ['ساده', 'ست'] },
                { url: 'assets/fabric/selina/female/1770108723545.png', tags: ['ساده', 'ست'] },
            ],
            selina_children: [],
            poliEsterPanbeh_male: [
                { url: 'assets/fabric/poliEsterPanbeh_U/male/1766580642520.jpg', tags: ['ست', 'تیشرت'] },
                { url: 'assets/fabric/poliEsterPanbeh_U/male/1766833211341.jpg', tags: ['ست', 'تیشرت'] },
                { url: 'assets/fabric/poliEsterPanbeh_U/male/Gemini_Generated_Image_2bvgr32bvgr32bvg.png', tags: ['ست', 'تیشرت'] },
                { url: 'assets/fabric/poliEsterPanbeh_U/male/Gemini_Generated_Image_5la7ti5la7ti5la7.png', tags: ['ست', 'تیشرت'] },
                { url: 'assets/fabric/poliEsterPanbeh_U/male/Gemini_Generated_Image_ai9bq2ai9bq2ai9b.png', tags: ['ست', 'تیشرت'] },
                { url: 'assets/fabric/poliEsterPanbeh_U/male/Gemini_Generated_Image_gl82o1gl82o1gl82.png', tags: ['ست', 'تیشرت'] },
                { url: 'assets/fabric/poliEsterPanbeh_U/male/Gemini_Generated_Image_iy4dfyiy4dfyiy4d.png', tags: ['ست', 'تیشرت'] },
                { url: 'assets/fabric/poliEsterPanbeh_U/male/Gemini_Generated_Image_m4j24xm4j24xm4j2.png', tags: ['ست', 'تیشرت'] },
                { url: 'assets/fabric/poliEsterPanbeh_U/male/Gemini_Generated_Image_nxa0fonxa0fonxa0.png', tags: ['ست', 'تیشرت'] },
                { url: 'assets/fabric/poliEsterPanbeh_U/male/Gemini_Generated_Image_oic8txoic8txoic8.png', tags: ['ست', 'تیشرت'] },
                { url: 'assets/fabric/poliEsterPanbeh_U/male/Gemini_Generated_Image_r83ew0r83ew0r83e.png', tags: ['ست', 'تیشرت'] },
                { url: 'assets/fabric/poliEsterPanbeh_U/male/Gemini_Generated_Image_y0tdsly0tdsly0td.png', tags: ['ست', 'تیشرت'] },

            ],
            poliEsterPanbeh_female: [],
            poliEsterPanbeh_children: [],
        };

        // Tag Management System
        let TAGS_DB = {
            allTags: new Set(['نگینی', 'چاپی' ,'ساده' , 'شومیز', 'ست', 'تاپ', 'تیشرت', 'ست', 'تونیک', 'ساحلی']),
            imageTags: {} // imageUrl -> [tags]
        };

        // Initialize tags from gallery images
        function initializeTags() {
            TAGS_DB.allTags.clear();
            TAGS_DB.imageTags = {};

            // Extract tags from all images
            Object.values(GALLERY_IMAGES).forEach(categoryImages => {
                categoryImages.forEach(imageData => {
                    if (imageData.tags && Array.isArray(imageData.tags)) {
                        TAGS_DB.imageTags[imageData.url] = [...imageData.tags];
                        imageData.tags.forEach(tag => TAGS_DB.allTags.add(tag));
                    }
                });
            });

            saveTagsToStorage();
        }

        function saveTagsToStorage() {
            localStorage.setItem('reyhantex_tags', JSON.stringify({
                allTags: Array.from(TAGS_DB.allTags),
                imageTags: TAGS_DB.imageTags
            }));
        }

        function loadTagsFromStorage() {
            const savedTags = localStorage.getItem('reyhantex_tags');
            if (savedTags) {
                try {
                    const parsed = JSON.parse(savedTags);
                    TAGS_DB.allTags = new Set(parsed.allTags || []);
                    TAGS_DB.imageTags = parsed.imageTags || {};

                    // Update gallery images with saved tags
                    Object.values(GALLERY_IMAGES).forEach(categoryImages => {
                        categoryImages.forEach(imageData => {
                            if (TAGS_DB.imageTags[imageData.url]) {
                                imageData.tags = TAGS_DB.imageTags[imageData.url];
                            }
                        });
                    });
                } catch (e) {
                    console.error('Error loading tags:', e);
                }
            }
        }

        function addTagToImage(imageUrl, tag) {
            if (!TAGS_DB.imageTags[imageUrl]) {
                TAGS_DB.imageTags[imageUrl] = [];
            }

            if (!TAGS_DB.imageTags[imageUrl].includes(tag)) {
                TAGS_DB.imageTags[imageUrl].push(tag);
                TAGS_DB.allTags.add(tag);

                // Update the image data in gallery
                Object.values(GALLERY_IMAGES).forEach(categoryImages => {
                    const image = categoryImages.find(img => img.url === imageUrl);
                    if (image) {
                        image.tags = TAGS_DB.imageTags[imageUrl];
                    }
                });

                saveTagsToStorage();
                return true;
            }
            return false;
        }

        function removeTagFromImage(imageUrl, tag) {
            if (TAGS_DB.imageTags[imageUrl]) {
                const index = TAGS_DB.imageTags[imageUrl].indexOf(tag);
                if (index > -1) {
                    TAGS_DB.imageTags[imageUrl].splice(index, 1);

                    // Update the image data in gallery
                    Object.values(GALLERY_IMAGES).forEach(categoryImages => {
                        const image = categoryImages.find(img => img.url === imageUrl);
                        if (image) {
                            image.tags = TAGS_DB.imageTags[imageUrl];
                        }
                    });

                    saveTagsToStorage();
                    return true;
                }
            }
            return false;
        }

        function getImagesByTag(tag) {
            const results = [];

            Object.entries(GALLERY_IMAGES).forEach(([category, images]) => {
                images.forEach(imageData => {
                    if (imageData.tags && imageData.tags.includes(tag)) {
                        results.push({
                            url: imageData.url,
                            category: category,
                            tags: imageData.tags,
                            fabric: getFabricFromCategory(category),
                            categoryName: getCategoryNameFromKey(category)
                        });
                    }
                });
            });

            return results;
        }

        function getAllTags() {
            return Array.from(TAGS_DB.allTags).sort();
        }

        function getFabricFromCategory(categoryKey) {
            const fabricName = categoryKey.split('_')[0];
            const fabric = FABRICS.find(f => getFabricNameById(f.id) === fabricName);
            return fabric ? fabric.name : fabricName;
        }

        function getCategoryNameFromKey(categoryKey) {
            const categoryId = categoryKey.split('_')[1];
            const category = CATEGORIES.find(c => c.id === categoryId);
            return category ? category.label : categoryId;
        }

        // Get all images from entire platform
        function getAllImages() {
            const allImages = [];

            Object.entries(GALLERY_IMAGES).forEach(([categoryKey, images]) => {
                images.forEach(imageData => {
                    allImages.push({
                        url: imageData.url,
                        tags: imageData.tags || [],
                        category: categoryKey,
                        fabric: getFabricFromCategory(categoryKey),
                        categoryName: getCategoryNameFromKey(categoryKey)
                    });
                });
            });

            return allImages;
        }

        // SIMPLE FUNCTION TO OPEN IMAGE IN NEW TAB
        function openImageInNewTab(imageUrl) {
            if (imageUrl) {
                window.open(imageUrl, '_blank');
            }
        }

        // Helper function to get random image for a fabric
        function getRandomImageForFabric(fabricId) {
            const fabricName = getFabricNameById(fabricId);
            const allImages = [
                ...(GALLERY_IMAGES[`${fabricName}_male`] || []),
                ...(GALLERY_IMAGES[`${fabricName}_female`] || []),
                ...(GALLERY_IMAGES[`${fabricName}_children`] || [])
            ];

            if (allImages.length > 0) {
                const randomImage = allImages[Math.floor(Math.random() * allImages.length)];
                return randomImage.url;
            }

            // Fallback to default image if no gallery images
            return FABRICS.find(f => f.id === fabricId).image;
        }

        // Helper function to get all images for a fabric
        function getAllImagesForFabric(fabricId) {
            const fabricName = getFabricNameById(fabricId);
            const images = [
                ...(GALLERY_IMAGES[`${fabricName}_male`] || []),
                ...(GALLERY_IMAGES[`${fabricName}_female`] || []),
                ...(GALLERY_IMAGES[`${fabricName}_children`] || [])
            ];
            return images.map(img => img.url);
        }

        // Image Management Functions
        function saveImagesToStorage() {
            const imagesToSave = {};
            Object.keys(GALLERY_IMAGES).forEach(key => {
                imagesToSave[key] = GALLERY_IMAGES[key];
            });
            localStorage.setItem('reyhantex_gallery_images', JSON.stringify(imagesToSave));
        }

        function loadImagesFromStorage() {
            const savedImages = localStorage.getItem('reyhantex_gallery_images');
            if (savedImages) {
                try {
                    const parsed = JSON.parse(savedImages);
                    // Merge with default images (preserve originals)
                    Object.keys(parsed).forEach(key => {
                        if (GALLERY_IMAGES[key]) {
                            // Add only new images that don't already exist
                            parsed[key].forEach(imgData => {
                                const exists = GALLERY_IMAGES[key].some(existingImg =>
                                    existingImg.url === imgData.url
                                );
                                if (!exists) {
                                    GALLERY_IMAGES[key].push(imgData);
                                }
                            });
                        } else {
                            GALLERY_IMAGES[key] = parsed[key];
                        }
                    });
                } catch (e) {
                    console.error('Error loading saved images:', e);
                }
            }
        }

        function getFabricNameById(id) {
            const fabricNames = { 1: 'reyhana', 2: 'pofaki', 3: 'selina', 4: 'poliEsterPanbeh' };
            return fabricNames[id];
        }

        function getGalleryImages(fabricId, categoryId) {
            const fabricName = getFabricNameById(fabricId);
            const key = `${fabricName}_${categoryId}`;
            return GALLERY_IMAGES[key] || [];
        }

        // Image Upload Handler
        async function handleImageUpload(fabricId, categoryId, files) {
            const fabricName = getFabricNameById(fabricId);
            const key = `${fabricName}_${categoryId}`;

            if (!GALLERY_IMAGES[key]) {
                GALLERY_IMAGES[key] = [];
            }

            const categoryLabel = CATEGORIES.find(c => c.id === categoryId)?.label || categoryId;

            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    // Convert image to data URL
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        const imageUrl = e.target.result;
                        const imageData = {
                            url: imageUrl,
                            tags: []
                        };
                        GALLERY_IMAGES[key].push(imageData);

                        saveImagesToStorage();
                        showNotification(`تصویر ${categoryLabel} با موفقیت آپلود شد`, 'success');

                        // Refresh view if we're in admin panel
                        if (state.view === 'admin' || state.view === 'imageUpload' || state.view === 'tagManager' || state.view === 'allImages') {
                            render();
                        }
                    };

                    reader.readAsDataURL(file);
                }
            }
        }

        // Simple Database
        class SimpleMemoryDB {
            constructor() {
                this.customers = JSON.parse(localStorage.getItem('reyhantex_customers') || '[]');
                this.phoneSet = new Set(this.customers.map(c => c.phone));
            }

            saveToStorage() {
                localStorage.setItem('reyhantex_customers', JSON.stringify(this.customers));
            }

            addCustomer(data) {
                if (this.phoneSet.has(data.phone)) {
                    return { success: false, message: 'شماره تلفن تکراری است' };
                }

                const customer = {
                    id: Date.now(),
                    ...data,
                    timestamp: new Date().toISOString()
                };

                this.customers.push(customer);
                this.phoneSet.add(data.phone);
                this.saveToStorage();

                return { success: true, message: 'اطلاعات با موفقیت ثبت شد' };
            }

            getAllCustomers() {
                return [...this.customers].reverse();
            }

            clearAll() {
                this.customers = [];
                this.phoneSet.clear();
                this.saveToStorage();
            }
        }

        const db = new SimpleMemoryDB();

        // Application State
        const state = {
            view: 'gate',
            userData: { name: '', phone: '', instagram: '' },
            selectedFabric: null,
            selectedCategory: null,
            adminUploadState: {
                selectedFabric: null,
                selectedCategory: null,
                uploadedImages: []
            },
            tagSearchState: {
                isOpen: false,
                searchQuery: '',
                searchResults: [],
                selectedTag: null
            },
            tagManagerState: {
                isOpen: false,
                selectedFabric: null,
                selectedCategory: null,
                selectedImage: null,
                bulkTags: []
            }
        };

        // Navigation Helper
        function navigateTo(view) {
            state.view = view;
            render();
            window.scrollTo(0, 0);
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg animate-slide-up ${type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' :
                    type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600'
                }`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <i data-lucide="${type === 'success' ? 'check-circle' :
                    type === 'error' ? 'alert-circle' :
                        type === 'warning' ? 'alert-triangle' : 'info'
                }" class="w-5 h-5"></i>
                    <span class="font-bold">${message}</span>
                </div>
            `;

            document.body.appendChild(notification);
            lucide.createIcons();

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Logo Component
        function getLogoMarkup(size = 'w-40 h-40', animate = true) {
            return `
                <div class="flex flex-col items-center justify-center ${animate ? 'animate-logo-float' : ''}">
                    <div class="${size} rounded-full overflow-hidden border-4 border-reyhan-gold/30 logo-glow">
                        <img src="${CONFIG.logoImage}"
                             alt="REYHANTEX Logo"
                             class="w-full h-full object-cover logo-image">
                    </div>
                    <h1 class="text-gold font-black tracking-[0.3em] text-3xl mt-4 drop-shadow-lg">REYHANTEX</h1>
                </div>
            `;
        }

        // All Images Gallery View
        function createAllImagesView() {
            const allImages = getAllImages();

            const el = document.createElement('div');
            el.className = 'min-h-screen animate-fade-in bg-green-gradient';
            el.innerHTML = `
                <div class="pt-20 pb-12 px-4">
                    <!-- Header -->
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-bold text-white">همه تصاویر پلتفرم</h2>
                        <p class="text-reyhan-gold text-sm mt-2">${allImages.length} تصویر از تمامی پارچه‌ها و دسته‌بندی‌ها</p>
                    </div>
                    
                    <!-- Filter Options -->
                    <div class="glass-panel rounded-2xl p-6 mb-8 backdrop-blur-xl">
                        <div class="flex flex-wrap gap-4 items-center justify-between">
                            <div class="flex items-center gap-4">
                                <span class="text-white font-bold">فیلترها:</span>
                                <select id="fabricFilter" class="bg-reyhan-dark/50 text-white px-4 py-2 rounded-lg border border-reyhan-gold/30">
                                    <option value="">همه پارچه‌ها</option>
                                    ${FABRICS.map(fabric => `
                                        <option value="${fabric.id}">${fabric.name}</option>
                                    `).join('')}
                                </select>
                                <select id="categoryFilter" class="bg-reyhan-dark/50 text-white px-4 py-2 rounded-lg border border-reyhan-gold/30">
                                    <option value="">همه دسته‌بندی‌ها</option>
                                    ${CATEGORIES.map(category => `
                                        <option value="${category.id}">${category.label}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="text-reyhan-gold">
                                <i data-lucide="images" class="w-5 h-5 inline ml-1"></i>
                                ${allImages.length} تصویر
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gallery Grid -->
                    ${allImages.length > 0 ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="allImagesGrid">
                            ${allImages.map((imageData, index) => {
                const tags = imageData.tags || [];
                return `
                                <div class="relative bg-reyhan-dark/50 rounded-xl overflow-hidden border border-reyhan-gold/20 hover:border-reyhan-gold transition-all duration-300 image-container group"
                                     data-fabric="${imageData.fabric}"
                                     data-category="${imageData.categoryName}">
                                    
                                    <!-- Image Info Badge -->
                                    <div class="absolute top-2 right-2 z-20 flex flex-col gap-1">
                                        <span class="bg-blue-600/80 text-white text-xs px-2 py-1 rounded">${imageData.fabric}</span>
                                        <span class="bg-pink-600/80 text-white text-xs px-2 py-1 rounded">${imageData.categoryName}</span>
                                    </div>
                                    
                                    <!-- Tag Badge -->
                                    ${tags.length > 0 ? `
                                        <div class="image-tag-badge" onclick="openImageTagEditor('${imageData.url}')">
                                            <i data-lucide="tag" class="w-3 h-3 inline ml-1"></i>
                                            ${tags.length} تگ
                                        </div>
                                    ` : `
                                        <div class="image-tag-badge" onclick="openImageTagEditor('${imageData.url}')">
                                            <i data-lucide="tag" class="w-3 h-3"></i>
                                            افزودن تگ
                                        </div>
                                    `}
                                    
                                    <!-- Image -->
                                    <img src="${imageData.url}"
                                         class="w-full h-64 object-cover cursor-pointer group-hover:scale-105 transition-transform duration-300"
                                         onclick="openImageInNewTab('${imageData.url}')">
                                    
                                    <!-- Tags Overlay -->
                                    <div class="image-tags-overlay">
                                        ${tags.length > 0 ? `
                                            <div class="flex flex-wrap gap-1 justify-center">
                                                ${tags.map(tag => `
                                                    <span class="text-xs bg-reyhan-gold/50 px-2 py-1 rounded">
                                                        ${tag}
                                                    </span>
                                                `).join('')}
                                            </div>
                                        ` : `
                                            <p class="text-gray-400 text-xs text-center">برای افزودن تگ روی آیکون تگ کلیک کنید</p>
                                        `}
                                    </div>
                                    
                                    <!-- Quick Tag Button -->
                                    <button onclick="openImageTagEditor('${imageData.url}')"
                                            class="quick-tag-btn">
                                        <i data-lucide="tag" class="w-4 h-4"></i>
                                    </button>
                                    
                                    <!-- Image Number -->
                                    <div class="absolute top-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded">
                                        ${index + 1}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-16 glass-panel rounded-2xl max-w-md mx-auto">
                            <i data-lucide="image-off" class="w-16 h-16 text-reyhan-gold/50 mx-auto mb-4"></i>
                            <p class="text-gray-300">هیچ تصویری در پلتفرم وجود ندارد</p>
                        </div>
                    `}
                    
                    <!-- Back Button -->
                    <div class="text-center mt-12">
                        <button onclick="navigateTo('landing')"
                                class="inline-flex items-center gap-2 px-6 py-3 border-2 border-reyhan-gold/50 text-reyhan-gold rounded-lg hover:bg-reyhan-gold/10 transition-all backdrop-blur-sm">
                            <i data-lucide="arrow-right"></i>
                            بازگشت به صفحه اصلی
                        </button>
                    </div>
                </div>
            `;

            // Add filter functionality
            setTimeout(() => {
                const fabricFilter = el.querySelector('#fabricFilter');
                const categoryFilter = el.querySelector('#categoryFilter');
                const imagesGrid = el.querySelector('#allImagesGrid');

                if (fabricFilter && categoryFilter && imagesGrid) {
                    const filterImages = () => {
                        const selectedFabric = fabricFilter.value;
                        const selectedCategory = categoryFilter.value;

                        const images = imagesGrid.querySelectorAll('.image-container');
                        images.forEach(img => {
                            const fabric = img.getAttribute('data-fabric');
                            const category = img.getAttribute('data-category');

                            let show = true;

                            if (selectedFabric) {
                                const fabricObj = FABRICS.find(f => f.id === parseInt(selectedFabric));
                                if (fabricObj && fabric !== fabricObj.name) {
                                    show = false;
                                }
                            }

                            if (selectedCategory && show) {
                                const categoryObj = CATEGORIES.find(c => c.id === selectedCategory);
                                if (categoryObj && category !== categoryObj.label) {
                                    show = false;
                                }
                            }

                            img.style.display = show ? 'block' : 'none';
                        });
                    };

                    fabricFilter.addEventListener('change', filterImages);
                    categoryFilter.addEventListener('change', filterImages);
                }
            }, 100);

            return el;
        }

        // Tag Search Modal
        function createTagSearchModal() {
            if (!state.tagSearchState.isOpen) return '';

            const allTags = getAllTags();
            const filteredTags = allTags.filter(tag =>
                tag.includes(state.tagSearchState.searchQuery)
            );

            return `
                <div class="fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4 animate-fade-in">
                    <div class="bg-reyhan-green rounded-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden border border-reyhan-gold/30">
                        <div class="p-6 border-b border-reyhan-gold/20">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-white">جستجوی تگ</h3>
                                <button onclick="closeTagSearch()" class="text-reyhan-gold hover:text-reyhan-goldLight">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <div class="relative">
                                <input type="text"
                                       id="tagSearchInput"
                                       class="w-full px-4 py-3 bg-reyhan-dark/50 border border-reyhan-gold/30 rounded-lg text-white placeholder-gray-400"
                                       placeholder="جستجوی تگ..."
                                       value="${state.tagSearchState.searchQuery}"
                                       oninput="updateTagSearch(event)">
                                <i data-lucide="search" class="absolute left-3 top-3.5 w-5 h-5 text-reyhan-gold/50"></i>
                            </div>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-[50vh]">
                            ${filteredTags.length > 0 ? `
                                <div class="flex flex-wrap gap-2 mb-6">
                                    ${filteredTags.map(tag => `
                                        <button onclick="searchByTag('${tag}')"
                                                class="tag ${state.tagSearchState.selectedTag === tag ? 'active' : ''}">
                                            ${tag}
                                            <span class="text-xs text-reyhan-goldLight">(${getImagesByTag(tag).length})</span>
                                        </button>
                                    `).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-8 text-gray-400">
                                    <i data-lucide="tag" class="w-12 h-12 mx-auto mb-4"></i>
                                    <p>تگی یافت نشد</p>
                                </div>
                            `}
                            
                            ${state.tagSearchState.selectedTag ? `
                                <div class="mt-6">
                                    <h4 class="text-lg font-bold text-white mb-4">
                                        تصاویر با تگ "${state.tagSearchState.selectedTag}"
                                        <span class="text-reyhan-gold text-sm">(${state.tagSearchState.searchResults.length} تصویر)</span>
                                    </h4>
                                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                        ${state.tagSearchState.searchResults.map((img, index) => {
                const tags = img.tags || [];
                return `
                                            <div class="relative rounded-lg overflow-hidden border border-reyhan-gold/20 group cursor-pointer image-container">
                                                <img src="${img.url}" class="w-full h-32 object-cover">
                                                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-end justify-end p-2">
                                                    <div class="text-white text-xs text-left">
                                                        <div class="font-bold">${img.fabric}</div>
                                                        <div>${img.categoryName}</div>
                                                    </div>
                                                </div>
                                                <div class="image-tags-overlay">
                                                    ${tags.length > 0 ? `
                                                        <div class="flex flex-wrap gap-1 justify-center">
                                                            ${tags.map(tag => `<span class="text-xs bg-reyhan-gold/30 px-2 py-1 rounded">${tag}</span>`).join('')}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                                <button onclick="openImageInNewTab('${img.url}')" 
                                                        class="quick-tag-btn">
                                                    <i data-lucide="zoom-in" class="w-3 h-3"></i>
                                                </button>
                                            </div>
                                        `}).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="p-6 border-t border-reyhan-gold/20">
                            <div class="flex justify-between">
                                <button onclick="closeTagSearch()"
                                        class="px-4 py-2 border border-reyhan-gold/50 text-reyhan-gold rounded-lg hover:bg-reyhan-gold/10">
                                    بستن
                                </button>
                                <div class="flex gap-4">
                                    <button onclick="openAllImages()"
                                            class="px-4 py-2 bg-reyhan-gold/20 text-reyhan-gold rounded-lg hover:bg-reyhan-gold/30 text-sm flex items-center gap-2">
                                        <i data-lucide="grid" class="w-4 h-4"></i>
                                        همه تصاویر
                                    </button>
                                    <div class="text-sm text-reyhan-gold/70">
                                        <i data-lucide="tags" class="w-4 h-4 inline ml-1"></i>
                                        ${allTags.length} تگ موجود
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.openTagSearch = () => {
            state.tagSearchState.isOpen = true;
            state.tagSearchState.searchQuery = '';
            state.tagSearchState.searchResults = [];
            state.tagSearchState.selectedTag = null;
            render();
            setTimeout(() => {
                const input = document.getElementById('tagSearchInput');
                if (input) input.focus();
            }, 100);
        };

        window.closeTagSearch = () => {
            state.tagSearchState.isOpen = false;
            render();
        };

        window.updateTagSearch = (event) => {
            state.tagSearchState.searchQuery = event.target.value;
            state.tagSearchState.selectedTag = null;
            state.tagSearchState.searchResults = [];
            render();
        };

        window.searchByTag = (tag) => {
            state.tagSearchState.selectedTag = tag;
            state.tagSearchState.searchResults = getImagesByTag(tag);
            render();
        };

        window.openAllImages = () => {
            state.tagSearchState.isOpen = false;
            state.view = 'allImages';
            render();
        };

        // Enhanced Tag Manager
        function createTagManagerView() {
            const el = document.createElement('div');
            el.className = 'min-h-screen bg-green-gradient p-4 animate-fade-in';

            el.innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <!-- Header -->
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-white">مدیریت تگ‌های تصاویر</h1>
                        <p class="text-reyhan-gold">تگ‌ها را به تصاویر اضافه، حذف یا ویرایش کنید</p>
                    </div>
                    
                    <!-- Fabric and Category Selection -->
                    <div class="glass-panel rounded-2xl p-6 mb-6 backdrop-blur-xl">
                        <h2 class="text-xl font-bold text-white mb-4">انتخاب پارچه و دسته‌بندی</h2>
                        
                        <!-- Fabric Selection -->
                        <div class="mb-6">
                            <h3 class="font-bold text-reyhan-gold mb-3">پارچه</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                ${FABRICS.map(fabric => `
                                    <button onclick="selectFabricInTagManager(${fabric.id})"
                                            class="p-4 rounded-lg text-center transition-all ${state.tagManagerState.selectedFabric?.id === fabric.id ?
                    'bg-reyhan-gold text-reyhan-dark font-bold' :
                    'bg-reyhan-dark/50 text-white hover:bg-reyhan-dark/70'}">
                                        ${fabric.name}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Category Selection -->
                        ${state.tagManagerState.selectedFabric ? `
                            <div class="mb-6">
                                <h3 class="font-bold text-reyhan-gold mb-3">دسته‌بندی</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    ${CATEGORIES.map(category => `
                                        <button onclick="selectCategoryInTagManager('${category.id}')"
                                                class="p-4 rounded-lg text-center transition-all ${state.tagManagerState.selectedCategory === category.id ?
                            `${category.color} border-2 border-reyhan-gold font-bold text-white` :
                            'bg-reyhan-dark/50 text-white hover:bg-reyhan-dark/70'}">
                                            ${category.label}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- All Tags Quick Access -->
                        ${state.tagManagerState.selectedFabric && state.tagManagerState.selectedCategory ? `
                            <div class="mt-6 pt-6 border-t border-reyhan-gold/20">
                                <h3 class="font-bold text-white mb-3">تگ‌های موجود</h3>
                                <div class="flex flex-wrap gap-2 mb-4">
                                    ${getAllTags().map(tag => `
                                        <span class="tag ${state.tagManagerState.bulkTags.includes(tag) ? 'active' : ''}"
                                              onclick="toggleBulkTag('${tag}')">
                                            ${tag}
                                        </span>
                                    `).join('')}
                                </div>
                                <div class="flex gap-2">
                                    <input type="text"
                                           id="newTagInput"
                                           class="tag-input flex-1"
                                           placeholder="تگ جدید...">
                                    <button onclick="addNewTagToBulk()"
                                            class="px-4 py-2 bg-reyhan-gold/20 text-reyhan-gold rounded-lg hover:bg-reyhan-gold/30">
                                        افزودن تگ جدید
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Image Gallery for Tag Management -->
                    ${state.tagManagerState.selectedFabric && state.tagManagerState.selectedCategory ? `
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-white">
                                    تصاویر ${state.tagManagerState.selectedFabric.name} - ${CATEGORIES.find(c => c.id === state.tagManagerState.selectedCategory)?.label}
                                </h2>
                                <div class="text-sm text-reyhan-gold">
                                    <i data-lucide="images" class="w-4 h-4 inline ml-1"></i>
                                    ${getGalleryImages(state.tagManagerState.selectedFabric.id, state.tagManagerState.selectedCategory).length} تصویر
                                </div>
                            </div>
                            
                            ${(() => {
                        const images = getGalleryImages(state.tagManagerState.selectedFabric.id, state.tagManagerState.selectedCategory);
                        if (images.length === 0) {
                            return `
                                        <div class="text-center py-12 glass-panel rounded-2xl">
                                            <i data-lucide="image-off" class="w-16 h-16 text-reyhan-gold/50 mx-auto mb-4"></i>
                                            <p class="text-gray-300">هیچ تصویری در این دسته‌بندی وجود ندارد</p>
                                        </div>
                                    `;
                        }

                        return `
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                        ${images.map((imageData, index) => {
                            const imageUrl = imageData.url;
                            const tags = imageData.tags || [];
                            return `
                                            <div class="relative bg-reyhan-dark/50 rounded-xl overflow-hidden border border-reyhan-gold/20 hover:border-reyhan-gold transition-all duration-300 image-container">
                                                <img src="${imageUrl}" 
                                                     class="w-full h-48 object-cover cursor-pointer"
                                                     onclick="openImageInNewTab('${imageUrl}')">
                                                
                                                <!-- Quick Tag Buttons -->
                                                <div class="absolute top-2 right-2 flex gap-2">
                                                    <button onclick="openImageTagEditor('${imageUrl}')"
                                                            class="bg-black/70 text-reyhan-gold p-2 rounded-lg hover:bg-black/90 transition-all"
                                                            title="مدیریت تگ‌ها">
                                                        <i data-lucide="tag" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="applyBulkTagsToImage('${imageUrl}')"
                                                            class="bg-reyhan-gold/80 text-reyhan-dark p-2 rounded-lg hover:bg-reyhan-gold transition-all"
                                                            title="اعمال تگ‌های انتخابی">
                                                        <i data-lucide="check" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                                
                                                <!-- Image Tags -->
                                                <div class="image-tags-overlay">
                                                    ${tags.length > 0 ? `
                                                        <div class="flex flex-wrap gap-1 justify-center">
                                                            ${tags.map(tag => `
                                                                <span class="text-xs bg-reyhan-gold/40 px-2 py-1 rounded flex items-center gap-1">
                                                                    ${tag}
                                                                    <i data-lucide="x" 
                                                                       class="w-2 h-2 cursor-pointer hover:text-red-300"
                                                                       onclick="removeTagFromImage('${imageUrl}', '${tag}')"></i>
                                                                </span>
                                                            `).join('')}
                                                        </div>
                                                    ` : `
                                                        <p class="text-gray-400 text-xs text-center">بدون تگ</p>
                                                    `}
                                                </div>
                                                
                                                <!-- Image Number -->
                                                <div class="absolute top-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded">
                                                    ${index + 1}
                                                </div>
                                            </div>
                                        `}).join('')}
                                    </div>
                                    
                                    <!-- Bulk Actions -->
                                    <div class="mt-6 glass-panel rounded-2xl p-6 backdrop-blur-xl">
                                        <h3 class="font-bold text-white mb-4">عملیات گروهی</h3>
                                        <div class="flex flex-wrap gap-4">
                                            <button onclick="applyBulkTagsToAll()"
                                                    class="px-4 py-2 bg-reyhan-gold/30 text-reyhan-gold rounded-lg hover:bg-reyhan-gold/40 transition-all flex items-center gap-2">
                                                <i data-lucide="check-square" class="w-4 h-4"></i>
                                                اعمال تگ‌های انتخابی به همه تصاویر
                                            </button>
                                            <button onclick="clearAllTagsFromCategory()"
                                                    class="px-4 py-2 bg-red-600/20 text-red-300 rounded-lg hover:bg-red-600/30 transition-all flex items-center gap-2">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                حذف همه تگ‌ها از این دسته
                                            </button>
                                            <button onclick="openBulkTagEditor()"
                                                    class="px-4 py-2 bg-blue-600/20 text-blue-300 rounded-lg hover:bg-blue-600/30 transition-all flex items-center gap-2">
                                                <i data-lucide="edit" class="w-4 h-4"></i>
                                                ویرایش تگ‌های گروهی
                                            </button>
                                        </div>
                                    </div>
                                `;
                    })()}
                        </div>
                    ` : ''}
                    
                    <!-- Action Buttons -->
                    <div class="flex justify-between mt-6">
                        <button onclick="navigateTo('admin')"
                                class="px-6 py-3 border-2 border-reyhan-gold/50 text-reyhan-gold rounded-lg font-bold hover:bg-reyhan-gold/10 transition-all backdrop-blur-sm">
                            بازگشت به پنل
                        </button>
                        
                        ${state.tagManagerState.selectedFabric && state.tagManagerState.selectedCategory ? `
                            <div class="flex gap-3">
                                <button onclick="openImageUploadFromTagManager()"
                                        class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold flex items-center gap-2 transition-all">
                                    <i data-lucide="upload" class="w-4 h-4"></i>
                                    آپلود تصاویر جدید
                                </button>
                                <button onclick="exportTagsReport()"
                                        class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold flex items-center gap-2 transition-all">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    خروجی گزارش تگ‌ها
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            return el;
        }

        // Tag Manager Functions
        window.openTagManager = () => {
            state.view = 'tagManager';
            state.tagManagerState = {
                isOpen: true,
                selectedFabric: null,
                selectedCategory: null,
                selectedImage: null,
                bulkTags: []
            };
            render();
        };

        window.selectFabricInTagManager = (fabricId) => {
            state.tagManagerState.selectedFabric = FABRICS.find(f => f.id === fabricId);
            state.tagManagerState.selectedCategory = null;
            state.tagManagerState.bulkTags = [];
            render();
        };

        window.selectCategoryInTagManager = (categoryId) => {
            state.tagManagerState.selectedCategory = categoryId;
            state.tagManagerState.bulkTags = [];
            render();
        };

        window.toggleBulkTag = (tag) => {
            const index = state.tagManagerState.bulkTags.indexOf(tag);
            if (index > -1) {
                state.tagManagerState.bulkTags.splice(index, 1);
            } else {
                state.tagManagerState.bulkTags.push(tag);
            }
            render();
        };

        window.addNewTagToBulk = () => {
            const input = document.getElementById('newTagInput');
            if (input && input.value.trim()) {
                const newTag = input.value.trim();
                if (!state.tagManagerState.bulkTags.includes(newTag)) {
                    state.tagManagerState.bulkTags.push(newTag);
                    TAGS_DB.allTags.add(newTag);
                    saveTagsToStorage();
                }
                input.value = '';
                render();
            }
        };

        window.applyBulkTagsToImage = (imageUrl) => {
            if (state.tagManagerState.bulkTags.length === 0) {
                showNotification('لطفا ابتدا تگ‌ها را انتخاب کنید', 'warning');
                return;
            }

            let addedCount = 0;
            state.tagManagerState.bulkTags.forEach(tag => {
                if (addTagToImage(imageUrl, tag)) {
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                showNotification(`${addedCount} تگ به تصویر اضافه شد`, 'success');
                render();
            }
        };

        window.applyBulkTagsToAll = () => {
            if (state.tagManagerState.bulkTags.length === 0) {
                showNotification('لطفا ابتدا تگ‌ها را انتخاب کنید', 'warning');
                return;
            }

            if (!state.tagManagerState.selectedFabric || !state.tagManagerState.selectedCategory) {
                showNotification('لطفا پارچه و دسته‌بندی را انتخاب کنید', 'error');
                return;
            }

            const fabricName = getFabricNameById(state.tagManagerState.selectedFabric.id);
            const key = `${fabricName}_${state.tagManagerState.selectedCategory}`;
            const images = GALLERY_IMAGES[key] || [];

            let totalAdded = 0;
            images.forEach(imageData => {
                state.tagManagerState.bulkTags.forEach(tag => {
                    if (addTagToImage(imageData.url, tag)) {
                        totalAdded++;
                    }
                });
            });

            if (totalAdded > 0) {
                showNotification(`${totalAdded} تگ به ${images.length} تصویر اضافه شد`, 'success');
                render();
            }
        };

        window.clearAllTagsFromCategory = () => {
            if (!state.tagManagerState.selectedFabric || !state.tagManagerState.selectedCategory) {
                showNotification('لطفا پارچه و دسته‌بندی را انتخاب کنید', 'error');
                return;
            }

            if (confirm('آیا مطمئن هستید که می‌خواهید تمام تگ‌ها را از تصاویر این دسته حذف کنید؟')) {
                const fabricName = getFabricNameById(state.tagManagerState.selectedFabric.id);
                const key = `${fabricName}_${state.tagManagerState.selectedCategory}`;
                const images = GALLERY_IMAGES[key] || [];

                let totalRemoved = 0;
                images.forEach(imageData => {
                    const tags = TAGS_DB.imageTags[imageData.url] || [];
                    tags.forEach(tag => {
                        if (removeTagFromImage(imageData.url, tag)) {
                            totalRemoved++;
                        }
                    });
                });

                if (totalRemoved > 0) {
                    showNotification(`${totalRemoved} تگ از ${images.length} تصویر حذف شد`, 'success');
                    render();
                }
            }
        };

        window.openBulkTagEditor = () => {
            const allTags = getAllTags();
            const tagList = allTags.map(tag => `${tag} (${getImagesByTag(tag).length})`).join('\n');

            const action = prompt(`مدیریت تگ‌ها:\n1. حذف تگ\n2. تغییر نام تگ\n3. ادغام تگ‌ها\n\nعدد عملیات را وارد کنید:`);

            if (action === '1') {
                const tagToDelete = prompt(`تگ‌های موجود:\n${tagList}\n\nنام تگی که می‌خواهید حذف کنید را وارد کنید:`);
                if (tagToDelete && allTags.includes(tagToDelete)) {
                    if (confirm(`آیا از حذف تگ "${tagToDelete}" مطمئن هستید؟ این تگ از ${getImagesByTag(tagToDelete).length} تصویر حذف خواهد شد.`)) {
                        // Remove tag from all images
                        Object.keys(TAGS_DB.imageTags).forEach(imageUrl => {
                            removeTagFromImage(imageUrl, tagToDelete);
                        });
                        // Remove from allTags
                        TAGS_DB.allTags.delete(tagToDelete);
                        saveTagsToStorage();
                        showNotification(`تگ "${tagToDelete}" حذف شد`, 'success');
                        render();
                    }
                } else if (tagToDelete) {
                    showNotification('تگ یافت نشد', 'error');
                }
            } else if (action === '2') {
                const oldTag = prompt(`تگ‌های موجود:\n${tagList}\n\nنام تگ قدیمی را وارد کنید:`);
                if (oldTag && allTags.includes(oldTag)) {
                    const newTag = prompt('نام جدید تگ را وارد کنید:');
                    if (newTag && newTag.trim()) {
                        // Update tag in all images
                        Object.keys(TAGS_DB.imageTags).forEach(imageUrl => {
                            if (TAGS_DB.imageTags[imageUrl].includes(oldTag)) {
                                removeTagFromImage(imageUrl, oldTag);
                                addTagToImage(imageUrl, newTag);
                            }
                        });
                        // Update allTags
                        TAGS_DB.allTags.delete(oldTag);
                        TAGS_DB.allTags.add(newTag);
                        saveTagsToStorage();
                        showNotification(`تگ "${oldTag}" به "${newTag}" تغییر یافت`, 'success');
                        render();
                    }
                } else if (oldTag) {
                    showNotification('تگ یافت نشد', 'error');
                }
            } else if (action === '3') {
                const tag1 = prompt('نام تگ اول را وارد کنید:');
                const tag2 = prompt('نام تگ دوم را وارد کنید:');

                if (tag1 && tag2 && allTags.includes(tag1) && allTags.includes(tag2)) {
                    if (confirm(`آیا می‌خواهید تگ "${tag2}" را با "${tag1}" ادغام کنید؟`)) {
                        // Merge tag2 into tag1
                        Object.keys(TAGS_DB.imageTags).forEach(imageUrl => {
                            if (TAGS_DB.imageTags[imageUrl].includes(tag2)) {
                                removeTagFromImage(imageUrl, tag2);
                                if (!TAGS_DB.imageTags[imageUrl].includes(tag1)) {
                                    addTagToImage(imageUrl, tag1);
                                }
                            }
                        });
                        // Remove tag2 from allTags
                        TAGS_DB.allTags.delete(tag2);
                        saveTagsToStorage();
                        showNotification(`تگ‌ها با موفقیت ادغام شدند`, 'success');
                        render();
                    }
                } else {
                    showNotification('تگ‌ها معتبر نیستند', 'error');
                }
            }
        };

        window.openImageTagEditor = (imageUrl) => {
            currentEditingImage = imageUrl;
            render();
        };

        window.openImageUploadFromTagManager = () => {
            state.adminUploadState = {
                selectedFabric: state.tagManagerState.selectedFabric,
                selectedCategory: state.tagManagerState.selectedCategory,
                uploadedImages: [],
                tags: [...state.tagManagerState.bulkTags]
            };
            state.view = 'imageUpload';
            render();
        };

        window.exportTagsReport = () => {
            if (!state.tagManagerState.selectedFabric || !state.tagManagerState.selectedCategory) {
                showNotification('لطفا پارچه و دسته‌بندی را انتخاب کنید', 'error');
                return;
            }

            const fabricName = getFabricNameById(state.tagManagerState.selectedFabric.id);
            const key = `${fabricName}_${state.tagManagerState.selectedCategory}`;
            const images = GALLERY_IMAGES[key] || [];

            const data = images.map((img, index) => ({
                'شماره': index + 1,
                'تگ‌ها': (img.tags || []).join(', '),
                'تعداد تگ': (img.tags || []).length
            }));

            try {
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "گزارش تگ‌ها");

                const fabricName = state.tagManagerState.selectedFabric.name.replace(/\s+/g, '_');
                const categoryName = CATEGORIES.find(c => c.id === state.tagManagerState.selectedCategory)?.label.replace(/\s+/g, '_');
                const date = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `tags_${fabricName}_${categoryName}_${date}.xlsx`);

                showNotification('گزارش تگ‌ها با موفقیت تولید شد', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('خطا در تولید گزارش', 'error');
            }
        };

        // Tag Editor Modal for Image
        function createTagEditorModal(imageUrl) {
            if (!imageUrl) return '';

            const currentTags = TAGS_DB.imageTags[imageUrl] || [];
            const allTags = getAllTags();

            return `
                <div class="fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4 animate-fade-in">
                    <div class="bg-reyhan-green rounded-2xl w-full max-w-md border border-reyhan-gold/30 max-h-[80vh] overflow-hidden">
                        <div class="p-6 border-b border-reyhan-gold/20">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-white">مدیریت تگ‌های تصویر</h3>
                                <button onclick="closeTagEditor()" class="text-reyhan-gold hover:text-reyhan-goldLight">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6 overflow-y-auto max-h-[60vh]">
                            <div class="mb-6">
                                <img src="${imageUrl}" 
                                     class="w-full h-48 object-cover rounded-lg mb-4 cursor-pointer"
                                     onclick="openImageInNewTab('${imageUrl}')">
                                <p class="text-gray-300 text-sm text-center">روی تصویر کلیک کنید تا در تب جدید باز شود</p>
                            </div>
                            
                            <div class="mb-6">
                                <h4 class="font-bold text-white mb-3">تگ‌های فعلی</h4>
                                ${currentTags.length > 0 ? `
                                    <div class="flex flex-wrap gap-2">
                                        ${currentTags.map(tag => `
                                            <span class="tag">
                                                ${tag}
                                                <i data-lucide="x" 
                                                   class="w-3 h-3 tag-remove"
                                                   onclick="removeImageTag('${imageUrl}', '${tag}')"></i>
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <p class="text-gray-400 text-sm">هیچ تگی برای این تصویر وجود ندارد</p>
                                `}
                            </div>
                            
                            <div class="mb-6">
                                <h4 class="font-bold text-white mb-3">افزودن تگ جدید</h4>
                                <div class="flex gap-2 mb-3">
                                    <input type="text" 
                                           id="newTagInput"
                                           class="flex-1 tag-input"
                                           placeholder="تگ جدید را وارد کنید..."
                                           onkeypress="if(event.key === 'Enter') addNewTagToImage('${imageUrl}')">
                                    <button onclick="addNewTagToImage('${imageUrl}')"
                                            class="px-4 py-2 bg-reyhan-gold/20 text-reyhan-gold rounded-lg hover:bg-reyhan-gold/30">
                                        افزودن
                                    </button>
                                </div>
                                
                                <div class="mt-4">
                                    <p class="text-sm text-reyhan-gold mb-2">تگ‌های پیشنهادی:</p>
                                    <div class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-2">
                                        ${allTags.filter(tag => !currentTags.includes(tag)).map(tag => `
                                            <button onclick="addExistingTagToImage('${imageUrl}', '${tag}')"
                                                    class="tag">
                                                ${tag}
                                                <i data-lucide="plus" class="w-3 h-3"></i>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6 border-t border-reyhan-gold/20">
                            <div class="flex justify-between">
                                <button onclick="closeTagEditor()"
                                        class="px-4 py-2 border border-reyhan-gold/50 text-reyhan-gold rounded-lg hover:bg-reyhan-gold/10">
                                    بستن
                                </button>
                                <div class="text-sm text-reyhan-gold/70">
                                    <i data-lucide="tag" class="w-4 h-4 inline ml-1"></i>
                                    ${currentTags.length} تگ
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        let currentEditingImage = null;

        window.closeTagEditor = () => {
            currentEditingImage = null;
            render();
        };

        window.addNewTagToImage = (imageUrl) => {
            const input = document.getElementById('newTagInput');
            if (input && input.value.trim()) {
                const newTag = input.value.trim();
                if (addTagToImage(imageUrl, newTag)) {
                    showNotification(`تگ "${newTag}" اضافه شد`, 'success');
                    input.value = '';
                    render();
                } else {
                    showNotification('این تگ قبلاً اضافه شده است', 'warning');
                }
            }
        };

        window.addExistingTagToImage = (imageUrl, tag) => {
            if (addTagToImage(imageUrl, tag)) {
                showNotification(`تگ "${tag}" اضافه شد`, 'success');
                render();
            }
        };

        window.removeImageTag = (imageUrl, tag) => {
            if (removeTagFromImage(imageUrl, tag)) {
                showNotification(`تگ "${tag}" حذف شد`, 'success');
                render();
            }
        };

        // Render Engine
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';

            // Add Search and All Images buttons to all pages except gate
            if (state.view !== 'gate') {
                // All Images Button
                const allImagesBtn = document.createElement('button');
                allImagesBtn.onclick = openAllImages;
                allImagesBtn.className = 'fixed top-4 right-16 z-50 p-3 bg-reyhan-gold/20 hover:bg-reyhan-gold/30 rounded-full transition-all backdrop-blur-sm';
                allImagesBtn.innerHTML = '<i data-lucide="grid" class="w-5 h-5 text-reyhan-gold"></i>';
                app.appendChild(allImagesBtn);

                // Search Button
                const searchBtn = document.createElement('button');
                searchBtn.onclick = openTagSearch;
                searchBtn.className = 'fixed top-4 right-4 z-50 p-3 bg-reyhan-gold/20 hover:bg-reyhan-gold/30 rounded-full transition-all backdrop-blur-sm';
                searchBtn.innerHTML = '<i data-lucide="search" class="w-5 h-5 text-reyhan-gold"></i>';
                app.appendChild(searchBtn);
            }

            // Add Home button to all pages except gate and landing
            if (state.view !== 'gate' && state.view !== 'landing') {
                const homeBtn = document.createElement('button');
                homeBtn.onclick = () => navigateTo('landing');
                homeBtn.className = 'fixed top-4 left-4 z-50 p-3 bg-reyhan-gold/20 hover:bg-reyhan-gold/30 rounded-full transition-all backdrop-blur-sm';
                homeBtn.innerHTML = '<i data-lucide="home" class="w-5 h-5 text-reyhan-gold"></i>';
                app.appendChild(homeBtn);
            }

            // Add Admin button on landing page
            if (state.view === 'landing') {
                const adminBtn = document.createElement('button');
                adminBtn.onclick = requestAdminAccess;
                adminBtn.className = 'fixed top-4 left-16 z-50 p-3 bg-reyhan-gold/20 hover:bg-reyhan-gold/30 rounded-full transition-all backdrop-blur-sm';
                adminBtn.innerHTML = '<i data-lucide="crown" class="w-5 h-5 text-reyhan-gold"></i>';
                app.appendChild(adminBtn);
            }

            switch (state.view) {
                case 'gate': app.appendChild(createGateView()); break;
                case 'landing': app.appendChild(createEnhancedLandingView()); break;
                case 'form': app.appendChild(createFormView()); break;
                case 'category': app.appendChild(createCategoryView()); break;
                case 'gallery': app.appendChild(createGalleryView()); break;
                case 'admin': app.appendChild(createEnhancedAdminView()); break;
                case 'imageUpload': app.appendChild(createImageUploadView()); break;
                case 'tagManager': app.appendChild(createTagManagerView()); break;
                case 'allImages': app.appendChild(createAllImagesView()); break;
            }

            // Add Tag Search Modal if open
            if (state.tagSearchState.isOpen) {
                app.innerHTML += createTagSearchModal();
            }

            // Add Tag Editor Modal if editing
            if (currentEditingImage) {
                app.innerHTML += createTagEditorModal(currentEditingImage);
            }

            setTimeout(() => lucide.createIcons(), 50);
        }

        // Admin Access Function
        function requestAdminAccess() {
            const password = prompt('لطفا رمز مدیریت را وارد کنید:');
            if (password === CONFIG.adminPassword) {
                navigateTo('admin');
            } else if (password) {
                showNotification('رمز عبور اشتباه است', 'error');
            }
        }

        // View 1: Gate
        function createGateView() {
            const el = document.createElement('div');
            el.className = 'w-full h-screen flex flex-col items-center justify-center bg-green-gradient relative animate-fade-in overflow-hidden';
            el.innerHTML = `
                <div class="absolute inset-0 opacity-20">
                    <div class="absolute top-1/4 left-1/4 w-64 h-64 bg-reyhan-gold rounded-full blur-3xl animate-pulse"></div>
                    <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-reyhan-gold rounded-full blur-3xl animate-pulse" style="animation-delay: 1s"></div>
                </div>
               
                <div class="relative z-10 text-center p-8 glass-panel rounded-2xl max-w-md w-full mx-4 backdrop-blur-xl">
                    ${getLogoMarkup('w-48 h-48', true)}
                   
                    <div class="mt-12">
                        <input type="password"
                               id="passwordInput"
                               class="w-full px-6 py-4 text-2xl text-center bg-reyhan-dark/70 border-2 border-reyhan-gold/50 rounded-xl text-white placeholder-white/30 focus:border-reyhan-gold focus:ring-2 focus:ring-reyhan-gold/30 transition-all backdrop-blur-sm"
                               placeholder="رمز ورود"
                               maxlength="4"
                               autocomplete="off">
                        <p id="errorMsg" class="text-red-300 mt-3 text-sm opacity-0 transition-opacity">رمز اشتباه است</p>
                       
                        <div class="mt-6 text-sm text-reyhan-gold/70">
                            <i data-lucide="info" class="w-4 h-4 inline ml-1"></i>
                            رمز پیش فرض: 123
                        </div>
                    </div>
                </div>
               
                <div class="absolute bottom-8 text-reyhan-gold/50 text-xs tracking-widest animate-pulse-subtle">ROYAL FABRIC COLLECTION</div>
            `;

            const input = el.querySelector('#passwordInput');
            const error = el.querySelector('#errorMsg');

            input.focus();

            input.addEventListener('input', (e) => {
                if (e.target.value === CONFIG.password) {
                    navigateTo('landing');
                } else if (e.target.value.length >= 3 && e.target.value !== CONFIG.password) {
                    error.style.opacity = '1';
                    e.target.value = '';
                    setTimeout(() => error.style.opacity = '0', 2000);
                }
            });

            return el;
        }

        // View 2: Enhanced Landing Page with Random Image Showcase
        function createEnhancedLandingView() {
            const el = document.createElement('div');
            el.className = 'w-full min-h-screen animate-fade-in';

            el.innerHTML = `
                <div id="headerSection" class="fixed top-0 left-0 right-0 z-40 transition-all duration-500 bg-green-gradient/95 backdrop-blur-md border-b border-reyhan-gold/10">
                    <div id="logoContainer" class="transition-all duration-500">
                        <div class="text-center">
                            ${getLogoMarkup('w-40 h-40', true)}
                        </div>
                    </div>
                </div>

                <!-- Hero Background -->
                <div class="absolute inset-0 pt-64">
                    <div class="absolute inset-0 bg-gradient-to-b from-reyhan-green/30 via-transparent to-reyhan-green"></div>
                    <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-reyhan-gold/5 rounded-full blur-3xl"></div>
                    <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-reyhan-gold/5 rounded-full blur-3xl"></div>
                </div>

                <div class="relative pt-80 pb-20 px-4 max-w-7xl mx-auto">
                    <div class="text-center mb-16 animate-slide-up" style="animation-delay: 0.2s">
                        <h2 class="text-4xl font-bold text-white mb-4">مجموعه پارچه‌های ریحان تکس</h2>
                        <p class="text-reyhan-gold text-lg max-w-2xl mx-auto">انتخاب پارچه مناسب، اولین قدم در خلق لباسی بی‌نظیر و ماندگار</p>
                    </div>
                   
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        ${FABRICS.map((fabric, index) => {
                // Get random image for this fabric
                const randomImage = getRandomImageForFabric(fabric.id);

                return `
                                <div onclick="selectFabric(${fabric.id})"
                                     class="group relative bg-gradient-to-br from-reyhan-dark to-reyhan-green rounded-3xl overflow-hidden cursor-pointer border-2 border-reyhan-gold/10 hover:border-reyhan-gold transition-all duration-500 hover:-translate-y-3 animate-slide-up"
                                     style="animation-delay: ${index * 0.1}s">
                                   
                                    <!-- Random Fabric Image -->
                                    <div class="aspect-square overflow-hidden relative">
                                        <img src="${randomImage}"
                                             class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700 cursor-pointer"
                                             onclick="openImageInNewTab('${randomImage}')">
                                        <div class="absolute inset-0 bg-gradient-to-t from-reyhan-green to-transparent opacity-80"></div>
                                       
                                        <!-- Price Tag -->
                                        <div class="absolute top-4 left-4 px-4 py-2 bg-reyhan-gold/20 backdrop-blur-sm rounded-full">
                                            <span class="text-reyhan-gold font-bold">${fabric.price}</span>
                                        </div>
                                    </div>
                                   
                                    <!-- Fabric Info -->
                                    <div class="p-6 relative">
                                        <h3 class="text-xl font-bold text-white mb-2">${fabric.name}</h3>
                                        <p class="text-reyhan-gold text-sm mb-4">${fabric.enName}</p>
                                       
                                        <!-- Category Tags -->
                                        <div class="flex gap-2 mt-4">
                                            <span class="px-3 py-1 bg-blue-900/30 text-blue-200 text-xs rounded-full border border-blue-700/30">آقایان</span>
                                            <span class="px-3 py-1 bg-pink-900/30 text-pink-200 text-xs rounded-full border border-pink-700/30">بانوان</span>
                                            <span class="px-3 py-1 bg-purple-900/30 text-purple-200 text-xs rounded-full border border-purple-700/30">کودکان</span>
                                        </div>
                                       
                                        <!-- Select Button -->
                                        <div class="mt-6 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                            <button class="w-full py-3 btn-gold rounded-lg font-bold flex items-center justify-center gap-2">
                                                <span>انتخاب پارچه</span>
                                                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
            }).join('')}
                    </div>
                   
                    <!-- Footer Note -->
                    <div class="text-center mt-16 text-reyhan-gold/50 text-sm">
                        <i data-lucide="star" class="w-4 h-4 inline ml-1"></i>
                        هر پارچه شامل سه دسته‌بندی مردانه، زنانه و کودک می‌باشد
                    </div>
                </div>
            `;

            // Scroll handler for shrinking header
            setTimeout(() => {
                const headerSection = el.querySelector('#headerSection');
                const logoContainer = el.querySelector('#logoContainer');

                const scrollHandler = () => {
                    const scrollY = window.scrollY;
                    const shrinkPoint = 50;

                    if (scrollY > shrinkPoint) {
                        // Shrunk state
                        headerSection.style.padding = '10px 0';
                        headerSection.style.height = '80px';
                        headerSection.style.backdropFilter = 'blur(20px)';
                        headerSection.style.backgroundColor = 'rgba(1, 58, 52, 0.98)';
                        headerSection.style.borderBottom = '1px solid rgba(212, 175, 55, 0.2)';

                        logoContainer.innerHTML = `
                            <div class="flex items-center justify-center gap-4">
                                <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-reyhan-gold/30">
                                    <img src="${CONFIG.logoImage}"
                                         alt="REYHANTEX Logo"
                                         class="w-full h-full object-cover">
                                </div>
                                <h1 class="text-gold font-black tracking-widest text-lg">REYHANTEX</h1>
                            </div>
                        `;
                    } else {
                        // Normal state
                        headerSection.style.padding = '20px 0';
                        headerSection.style.height = 'auto';
                        headerSection.style.backdropFilter = 'blur(10px)';
                        headerSection.style.backgroundColor = 'rgba(1, 58, 52, 0.95)';
                        headerSection.style.borderBottom = '1px solid rgba(212, 175, 55, 0.1)';

                        logoContainer.innerHTML = `
                            <div class="text-center">
                                ${getLogoMarkup('w-40 h-40', true)}
                            </div>
                        `;
                    }
                };

                window.addEventListener('scroll', scrollHandler);
                scrollHandler();
            }, 100);

            return el;
        }

        window.selectFabric = (id) => {
            state.selectedFabric = FABRICS.find(f => f.id === id);
            navigateTo('form');
        };

        // View 3: Form
        function createFormView() {
            const el = document.createElement('div');
            el.className = 'min-h-screen bg-green-gradient animate-fade-in';
            el.innerHTML = `
                <div class="pt-20 px-4 max-w-lg mx-auto">
                    <div class="glass-panel rounded-2xl p-8 backdrop-blur-xl">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-white mb-2">اطلاعات سفارش</h2>
                            <p class="text-reyhan-gold">
                                پارچه انتخاب شده:
                                <span class="font-bold">${state.selectedFabric.name}</span>
                            </p>
                        </div>
                       
                        <form id="customerForm" class="space-y-6">
                            <div>
                                <label class="block text-reyhan-gold text-sm font-bold mb-2">نام و نام خانوادگی</label>
                                <input type="text"
                                       id="nameInput"
                                       required
                                       class="w-full px-4 py-3 input-field rounded-lg text-white backdrop-blur-sm"
                                       placeholder="نام شما">
                            </div>
                           
                            <div>
                                <label class="block text-reyhan-gold text-sm font-bold mb-2">شماره تماس</label>
                                <input type="tel"
                                       id="phoneInput"
                                       required
                                       maxlength="11"
                                       class="w-full px-4 py-3 input-field rounded-lg text-white dir-ltr text-left backdrop-blur-sm"
                                       placeholder="09123456789">
                            </div>
                           
                            <div>
                                <label class="block text-reyhan-gold text-sm font-bold mb-2">اینستاگرام (اختیاری)</label>
                                <input type="text"
                                       id="instagramInput"
                                       class="w-full px-4 py-3 input-field rounded-lg text-white backdrop-blur-sm"
                                       placeholder="username@">
                            </div>
                           
                            <div class="grid grid-cols-2 gap-4 pt-4">
                                <button type="button"
                                        onclick="skipToCategory()"
                                        class="py-3 px-4 border-2 border-reyhan-gold text-reyhan-gold rounded-lg font-bold hover:bg-reyhan-gold/10 transition-all backdrop-blur-sm">
                                    <i data-lucide="skip-forward"></i>
                                    رد کردن
                                </button>
                               
                                <button type="submit"
                                        id="submitBtn"
                                        class="py-3 px-4 btn-gold rounded-lg font-bold flex items-center justify-center gap-2">
                                    <i data-lucide="arrow-left"></i>
                                    ادامه
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            const form = el.querySelector('#customerForm');
            const submitBtn = el.querySelector('#submitBtn');
            const nameInput = el.querySelector('#nameInput');
            const phoneInput = el.querySelector('#phoneInput');

            const validateForm = () => {
                const isValid = nameInput.value.length > 2 && phoneInput.value.length >= 10;
                submitBtn.disabled = !isValid;
                submitBtn.classList.toggle('opacity-50 cursor-not-allowed', !isValid);
                submitBtn.classList.toggle('hover:transform', isValid);
            };

            nameInput.addEventListener('input', validateForm);
            phoneInput.addEventListener('input', validateForm);

            form.onsubmit = (e) => {
                e.preventDefault();

                state.userData = {
                    name: nameInput.value.trim(),
                    phone: phoneInput.value.trim(),
                    instagram: el.querySelector('#instagramInput').value.trim()
                };

                const result = db.addCustomer({
                    ...state.userData,
                    fabric: state.selectedFabric.name,
                    category: ''
                });

                if (result.success) {
                    showNotification(result.message, 'success');
                    setTimeout(() => {
                        navigateTo('category');
                    }, 1000);
                } else {
                    showNotification(result.message, 'error');
                }
            };

            return el;
        }

        window.skipToCategory = () => {
            state.userData = { name: '', phone: '', instagram: '' };
            navigateTo('category');
        };

        // View 4: Category Selection
        function createCategoryView() {
            const el = document.createElement('div');
            el.className = 'min-h-screen animate-fade-in bg-green-gradient';
            el.innerHTML = `
                <div class="pt-20 pb-8 px-4">
                    <!-- Fabric Info Header -->
                    <div class="max-w-md mx-auto mb-8 glass-panel rounded-2xl p-6 backdrop-blur-xl">
                        <div class="text-center">
                            <p class="text-reyhan-gold text-sm mb-2">پارچه انتخابی</p>
                            <h3 class="text-xl font-bold text-white">${state.selectedFabric.name}</h3>
                            <p class="text-reyhan-gold text-sm">${state.selectedFabric.enName}</p>
                        </div>
                    </div>
                   
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-bold text-white">انتخاب دسته بندی</h2>
                        <p class="text-reyhan-gold text-sm mt-2">لطفا گروه مورد نظر خود را انتخاب کنید</p>
                    </div>
                   
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-6xl mx-auto">
                        ${CATEGORIES.map((category, index) => `
                            <div onclick="selectCategory('${category.id}')"
                                 class="group relative h-96 rounded-3xl overflow-hidden cursor-pointer border-2 ${category.border} hover:border-reyhan-gold transition-all duration-500 hover:-translate-y-2 animate-slide-up"
                                 style="animation-delay: ${index * 0.2}s">
                                <img src="${state.selectedFabric.categoryImages[category.id]}"
                                     class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700 cursor-pointer"
                                     onclick="openImageInNewTab('${state.selectedFabric.categoryImages[category.id]}')">
                                <div class="absolute inset-0 ${category.color} opacity-60"></div>
                                <div class="absolute inset-0 bg-gradient-to-t from-reyhan-green to-transparent opacity-70"></div>
                               
                                <div class="absolute bottom-0 left-0 right-0 p-8 text-center">
                                    <h3 class="text-2xl font-bold text-white">${category.label}</h3>
                                    <p class="text-reyhan-gold text-sm mt-2">${category.enLabel}</p>
                                    <p class="text-white/80 text-xs mt-3">${category.desc}</p>
                                    <div class="mt-4 inline-flex items-center gap-2 text-reyhan-gold bg-reyhan-gold/20 backdrop-blur-sm px-4 py-2 rounded-full">
                                        <span>انتخاب</span>
                                        <i data-lucide="arrow-left" class="w-4 h-4"></i>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                   
                    <!-- Back Button -->
                    <div class="text-center mt-12">
                        <button onclick="navigateTo('form')"
                                class="inline-flex items-center gap-2 px-6 py-3 border-2 border-reyhan-gold/50 text-reyhan-gold rounded-lg hover:bg-reyhan-gold/10 transition-all backdrop-blur-sm">
                            <i data-lucide="arrow-right"></i>
                            بازگشت به فرم
                        </button>
                    </div>
                </div>
            `;

            return el;
        }

        window.selectCategory = (categoryId) => {
            state.selectedCategory = categoryId;

            if (state.userData.name && state.userData.phone) {
                const customers = db.getAllCustomers();
                const latestCustomer = customers.find(c =>
                    c.name === state.userData.name &&
                    c.phone === state.userData.phone
                );

                if (latestCustomer) {
                    const index = db.customers.findIndex(c => c.id === latestCustomer.id);
                    if (index !== -1) {
                        db.customers[index].category = categoryId;
                        db.saveToStorage();
                    }
                }
            }

            setTimeout(() => {
                navigateTo('gallery');
            }, 300);
        };

        // View 5: Gallery/Showroom with Tags Display
        function createGalleryView() {
            const category = CATEGORIES.find(c => c.id === state.selectedCategory);
            const images = getGalleryImages(state.selectedFabric.id, state.selectedCategory);

            const el = document.createElement('div');
            el.className = 'min-h-screen animate-fade-in bg-green-gradient';
            el.innerHTML = `
                <div class="pt-20 pb-12 px-4">
                    <!-- Header -->
                    <div class="text-center mb-12">
                        <h2 class="text-3xl font-bold text-white">نمایشگاه ${category.label}</h2>
                        <p class="text-reyhan-gold text-sm mt-2">طراحی‌های زیبا با پارچه ${state.selectedFabric.name}</p>
                        ${images.length > 0 ? `
                            <p class="text-gray-300 text-sm mt-1">روی هر تصویر کلیک کنید تا در تب جدید باز شود</p>
                        ` : ''}
                    </div>
                   
                    <!-- Gallery Grid -->
                    ${images.length > 0 ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto">
                            ${images.map((imageData, index) => {
                const imageUrl = imageData.url;
                const tags = imageData.tags || [];
                return `
                                <div class="group relative rounded-2xl overflow-hidden border-2 border-reyhan-gold/20 hover:border-reyhan-gold transition-all duration-500 animate-slide-up backdrop-blur-sm image-container"
                                     style="animation-delay: ${index * 0.1}s">
                                    <!-- Tag Badge -->
                                    ${tags.length > 0 ? `
                                        <div class="image-tag-badge" onclick="openImageTagEditor('${imageUrl}')">
                                            <i data-lucide="tag" class="w-3 h-3 inline ml-1"></i>
                                            ${tags.length} تگ
                                        </div>
                                    ` : `
                                        <div class="image-tag-badge" onclick="openImageTagEditor('${imageUrl}')">
                                            <i data-lucide="tag" class="w-3 h-3"></i>
                                            افزودن تگ
                                        </div>
                                    `}
                                    
                                    <!-- Image -->
                                    <img src="${imageUrl}"
                                         class="w-full h-96 object-cover group-hover:scale-105 transition-transform duration-700 cursor-pointer"
                                         onclick="openImageInNewTab('${imageUrl}')">
                                    
                                    <!-- Tags Overlay -->
                                    <div class="image-tags-overlay">
                                        ${tags.length > 0 ? `
                                            <div class="flex flex-wrap gap-1 justify-center">
                                                ${tags.map(tag => `
                                                    <span class="text-xs bg-reyhan-gold/50 px-2 py-1 rounded">
                                                        ${tag}
                                                    </span>
                                                `).join('')}
                                            </div>
                                        ` : `
                                            <p class="text-gray-400 text-xs text-center">برای افزودن تگ روی آیکون تگ کلیک کنید</p>
                                        `}
                                    </div>
                                    
                                    <!-- Quick Tag Button -->
                                    <button onclick="openImageTagEditor('${imageUrl}')"
                                            class="quick-tag-btn">
                                        <i data-lucide="tag" class="w-4 h-4"></i>
                                    </button>
                                    
                                    <!-- Image Number -->
                                    <div class="absolute top-4 right-4 bg-black/50 text-white text-xs px-2 py-1 rounded">
                                        ${index + 1}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-16 glass-panel rounded-2xl max-w-md mx-auto">
                            <i data-lucide="image-off" class="w-16 h-16 text-reyhan-gold/50 mx-auto mb-4"></i>
                            <p class="text-gray-300">تصویری برای این دسته‌بندی موجود نیست</p>
                        </div>
                    `}
                   
                    <!-- Action Buttons -->
                    <div class="max-w-md mx-auto mt-16">
                        <div class="glass-panel rounded-2xl p-8 text-center backdrop-blur-xl">
                            <div class="w-16 h-16 bg-gradient-to-br from-reyhan-gold to-yellow-200 rounded-full flex items-center justify-center mx-auto mb-6 animate-float">
                                <i data-lucide="check" class="w-8 h-8 text-reyhan-dark"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-white mb-4">سفارش شما آماده است!</h3>
                            <p class="text-gray-300 mb-8">
                                پارچه <span class="text-reyhan-gold font-bold">${state.selectedFabric.name}</span><br>
                                برای گروه <span class="text-reyhan-gold font-bold">${category.label}</span>
                            </p>
                           
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="goBackToLanding()"
                                        class="py-3 px-4 border-2 border-reyhan-gold/50 text-reyhan-gold rounded-lg font-bold hover:bg-reyhan-gold/10 transition-all backdrop-blur-sm">
                                    بازگشت
                                </button>
                                <button onclick="finishOrder()"
                                        class="py-3 px-4 btn-gold rounded-lg font-bold">
                                    تکمیل سفارش
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return el;
        }

        // View 6: Enhanced Admin Panel
        function createEnhancedAdminView() {
            const customers = db.getAllCustomers();

            const el = document.createElement('div');
            el.className = 'min-h-screen bg-gray-100 p-4 animate-fade-in';
            el.innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <!-- Admin Header -->
                    <div class="bg-reyhan-green rounded-2xl p-6 mb-6 shadow-xl">
                        <div class="flex flex-col md:flex-row justify-between items-center">
                            <div class="text-center md:text-right mb-4 md:mb-0">
                                <h2 class="text-2xl font-bold text-white">پنل مدیریت REYHANTEX</h2>
                                <p class="text-reyhan-gold text-sm mt-1">تعداد رکوردها: ${customers.length}</p>
                            </div>
                            <div class="flex flex-wrap justify-center gap-3">
                                <button onclick="openTagManager()"
                                        class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl">
                                    <i data-lucide="tags" class="w-4 h-4"></i>
                                    مدیریت تگ‌های تصاویر
                                </button>
                                <button onclick="openImageUpload()"
                                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl">
                                    <i data-lucide="upload" class="w-4 h-4"></i>
                                    آپلود تصاویر جدید
                                </button>
                                <button onclick="exportToExcel()"
                                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    خروجی Excel
                                </button>
                                <button onclick="changeLogo()"
                                        class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl">
                                    <i data-lucide="image" class="w-4 h-4"></i>
                                    تغییر لوگو
                                </button>
                                <button onclick="manageFabricImages()"
                                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl">
                                    <i data-lucide="images" class="w-4 h-4"></i>
                                    مدیریت تصاویر پارچه
                                </button>
                                <button onclick="clearDatabase()"
                                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    پاک کردن همه
                                </button>
                                <button onclick="navigateTo('landing')"
                                        class="px-4 py-2 bg-gray-700 hover:bg-gray-800 text-white rounded-lg font-bold flex items-center gap-2 transition-all shadow-lg hover:shadow-xl">
                                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                                    بازگشت
                                </button>
                            </div>
                        </div>
                    </div>
                   
                    <!-- Tag Statistics -->
                    <div class="bg-white rounded-xl p-6 mb-6 shadow-lg border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">آمار تگ‌ها</h3>
                            <button onclick="openTagSearch()"
                                    class="px-4 py-2 bg-reyhan-green text-white rounded-lg hover:bg-reyhan-dark transition-all text-sm flex items-center gap-2">
                                <i data-lucide="search" class="w-4 h-4"></i>
                                جستجوی تگ
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-2xl font-bold text-reyhan-green mb-1">${getAllTags().length}</div>
                                <div class="text-sm text-gray-600">تعداد کل تگ‌ها</div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-2xl font-bold text-reyhan-green mb-1">${Object.keys(TAGS_DB.imageTags).length}</div>
                                <div class="text-sm text-gray-600">تصاویر دارای تگ</div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-2xl font-bold text-reyhan-green mb-1">${getAllImages().length}</div>
                                <div class="text-sm text-gray-600">کل تصاویر</div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-2xl font-bold text-reyhan-green mb-1">${Math.round(Object.values(TAGS_DB.imageTags).reduce((total, tags) => total + tags.length, 0) / (Object.keys(TAGS_DB.imageTags).length || 1))}</div>
                                <div class="text-sm text-gray-600">میانگین تگ بر تصویر</div>
                            </div>
                        </div>
                        <div>
                            <p class="text-sm text-gray-700 mb-2">تگ‌های پرکاربرد:</p>
                            <div class="flex flex-wrap gap-2">
                                ${getAllTags().slice(0, 15).map(tag => `
                                    <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm border">
                                        ${tag} <span class="text-reyhan-gold text-xs">(${getImagesByTag(tag).length})</span>
                                    </span>
                                `).join('')}
                                ${getAllTags().length > 15 ? `
                                    <span class="px-3 py-1 bg-gray-100 text-gray-500 rounded-full text-sm">
                                        +${getAllTags().length - 15} بیشتر
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                   
                    <!-- Current Logo Preview -->
                    <div class="bg-white rounded-xl p-6 mb-6 shadow-lg border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">لوگوی فعلی</h3>
                        <div class="flex flex-col md:flex-row items-center gap-6">
                            <div class="w-40 h-40 rounded-full overflow-hidden border-4 border-reyhan-gold/30">
                                <img src="${CONFIG.logoImage}"
                                     alt="Current Logo"
                                     class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1">
                                <p class="text-gray-600 mb-4">برای تغییر لوگو، روی دکمه "تغییر لوگو" کلیک کنید و لینک تصویر جدید را وارد نمایید.</p>
                                <div class="text-sm text-gray-500">
                                    <i data-lucide="info" class="w-4 h-4 inline ml-1"></i>
                                    لوگو باید تصویر مربع یا دایره باشد (نسبت 1:1)
                                </div>
                            </div>
                        </div>
                    </div>
                   
                    <!-- Image Statistics -->
                    <div class="bg-white rounded-xl p-6 mb-6 shadow-lg border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">آمار تصاویر بر اساس پارچه</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${FABRICS.map(fabric => {
                const fabricName = getFabricNameById(fabric.id);
                const totalImages =
                    (GALLERY_IMAGES[`${fabricName}_male`]?.length || 0) +
                    (GALLERY_IMAGES[`${fabricName}_female`]?.length || 0) +
                    (GALLERY_IMAGES[`${fabricName}_children`]?.length || 0);
                return `
                                    <div class="bg-gray-50 p-4 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors" onclick="selectFabricInTagManager(${fabric.id})">
                                        <h4 class="font-bold text-gray-800 mb-2">${fabric.name}</h4>
                                        <div class="text-sm text-gray-600">
                                            <div class="flex justify-between mb-1">
                                                <span>آقایان:</span>
                                                <span>${GALLERY_IMAGES[`${fabricName}_male`]?.length || 0}</span>
                                            </div>
                                            <div class="flex justify-between mb-1">
                                                <span>بانوان:</span>
                                                <span>${GALLERY_IMAGES[`${fabricName}_female`]?.length || 0}</span>
                                            </div>
                                            <div class="flex justify-between mb-1">
                                                <span>کودکان:</span>
                                                <span>${GALLERY_IMAGES[`${fabricName}_children`]?.length || 0}</span>
                                            </div>
                                            <div class="flex justify-between mt-2 pt-2 border-t border-gray-200">
                                                <span class="font-bold">مجموع:</span>
                                                <span class="font-bold text-reyhan-green">${totalImages}</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
            }).join('')}
                        </div>
                    </div>
                   
                    <!-- Customers Table -->
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-4 text-right font-bold text-gray-700">تاریخ</th>
                                        <th class="px-6 py-4 text-right font-bold text-gray-700">نام</th>
                                        <th class="px-6 py-4 text-right font-bold text-gray-700">تلفن</th>
                                        <th class="px-6 py-4 text-right font-bold text-gray-700">اینستاگرام</th>
                                        <th class="px-6 py-4 text-right font-bold text-gray-700">پارچه</th>
                                        <th class="px-6 py-4 text-right font-bold text-gray-700">دسته</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    ${customers.length ? customers.map(customer => `
                                        <tr class="hover:bg-yellow-50 transition-colors">
                                            <td class="px-6 py-4 text-gray-600 whitespace-nowrap">${new Date(customer.timestamp).toLocaleString('fa-IR')}</td>
                                            <td class="px-6 py-4 font-bold text-gray-800">${customer.name}</td>
                                            <td class="px-6 py-4 text-gray-700 dir-ltr text-left">${customer.phone}</td>
                                            <td class="px-6 py-4 text-gray-600">${customer.instagram || '-'}</td>
                                            <td class="px-6 py-4 font-bold text-reyhan-green">${customer.fabric}</td>
                                            <td class="px-6 py-4">
                                                <span class="px-2 py-1 rounded-full text-xs ${customer.category === 'male' ? 'bg-blue-100 text-blue-800' :
                    customer.category === 'female' ? 'bg-pink-100 text-pink-800' :
                        customer.category === 'children' ? 'bg-purple-100 text-purple-800' :
                            'bg-gray-100 text-gray-800'
                }">
                                                    ${customer.category ? CATEGORIES.find(c => c.id === customer.category)?.label : '-'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                                <i data-lucide="database" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                                                <p>هیچ رکوردی یافت نشد</p>
                                            </td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            return el;
        }

        // View 7: Image Upload Interface with Tags
        function createImageUploadView() {
            const el = document.createElement('div');
            el.className = 'min-h-screen bg-green-gradient p-4 animate-fade-in';
            el.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-white">آپلود تصاویر جدید</h2>
                        <p class="text-reyhan-gold">تصاویر را به پارچه و دسته‌بندی مورد نظر اضافه کنید</p>
                    </div>
                   
                    <div class="glass-panel rounded-2xl p-6 backdrop-blur-xl mb-6">
                        <!-- Fabric Selection -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-white mb-3">انتخاب پارچه</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                ${FABRICS.map(fabric => `
                                    <button onclick="selectFabricForUpload(${fabric.id})"
                                            class="p-4 rounded-lg text-center transition-all ${state.adminUploadState.selectedFabric?.id === fabric.id ?
                    'bg-reyhan-gold text-reyhan-dark font-bold' :
                    'bg-reyhan-dark/50 text-white hover:bg-reyhan-dark/70'}">
                                        ${fabric.name}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                       
                        <!-- Category Selection -->
                        ${state.adminUploadState.selectedFabric ? `
                            <div class="mb-6">
                                <h3 class="text-lg font-bold text-white mb-3">انتخاب دسته‌بندی</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    ${CATEGORIES.map(category => `
                                        <button onclick="selectCategoryForUpload('${category.id}')"
                                                class="p-4 rounded-lg text-center transition-all ${state.adminUploadState.selectedCategory === category.id ?
                            `${category.color} border-2 border-reyhan-gold font-bold text-white` :
                            'bg-reyhan-dark/50 text-white hover:bg-reyhan-dark/70'}">
                                            ${category.label}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                       
                        <!-- Tag Input for New Images -->
                        ${state.adminUploadState.selectedFabric && state.adminUploadState.selectedCategory ? `
                            <div class="mb-6">
                                <h3 class="text-lg font-bold text-white mb-3">تگ‌های تصاویر جدید</h3>
                                <div class="mb-4">
                                    <p class="text-gray-300 text-sm mb-3">تگ‌هایی که برای تصاویر جدید اضافه می‌شود:</p>
                                    <div id="uploadTagsContainer" class="flex flex-wrap gap-2 mb-3">
                                        ${state.adminUploadState.tags ? state.adminUploadState.tags.map(tag => `
                                            <span class="tag">
                                                ${tag}
                                                <i data-lucide="x" class="w-3 h-3 tag-remove" onclick="removeUploadTag('${tag}')"></i>
                                            </span>
                                        `).join('') : ''}
                                    </div>
                                    <div class="flex gap-2">
                                        <input type="text"
                                               id="uploadTagInput"
                                               class="tag-input flex-1"
                                               placeholder="افزودن تگ جدید...">
                                        <button onclick="addUploadTag()"
                                                class="px-4 py-2 bg-reyhan-gold/20 text-reyhan-gold rounded-lg hover:bg-reyhan-gold/30">
                                            افزودن
                                        </button>
                                    </div>
                                    <div class="mt-3">
                                        <p class="text-sm text-reyhan-gold mb-2">تگ‌های پرکاربرد:</p>
                                        <div class="flex flex-wrap gap-2">
                                            ${getAllTags().slice(0, 8).map(tag => `
                                                <button onclick="addExistingTagToUpload('${tag}')"
                                                        class="tag ${state.adminUploadState.tags?.includes(tag) ? 'active' : ''}">
                                                    ${tag}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                       
                        <!-- Image Upload Area -->
                        ${state.adminUploadState.selectedFabric && state.adminUploadState.selectedCategory ? `
                            <div class="mb-6">
                                <h3 class="text-lg font-bold text-white mb-3">آپلود تصاویر</h3>
                                <div class="image-upload-area"
                                     id="uploadArea"
                                     ondragover="handleDragOver(event)"
                                     ondragleave="handleDragLeave(event)"
                                     ondrop="handleDrop(event)">
                                    <i data-lucide="upload" class="w-16 h-16 text-reyhan-gold/50 mx-auto mb-4"></i>
                                    <p class="text-white mb-2">تصاویر را اینجا بکشید یا کلیک کنید</p>
                                    <p class="text-reyhan-gold text-sm mb-4">فرمت‌های مجاز: JPG, PNG, GIF</p>
                                    <input type="file"
                                           id="fileInput"
                                           accept="image/*"
                                           multiple
                                           class="hidden"
                                           onchange="handleFileSelect(event)">
                                    <button onclick="document.getElementById('fileInput').click()"
                                            class="px-6 py-2 btn-gold rounded-lg font-bold">
                                        انتخاب فایل
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div class="text-center py-8 text-gray-300">
                                <i data-lucide="image" class="w-12 h-12 mx-auto mb-4"></i>
                                <p>لطفا ابتدا پارچه و سپس دسته‌بندی را انتخاب کنید</p>
                            </div>
                        `}
                       
                        <!-- Current Images Preview -->
                        ${state.adminUploadState.selectedFabric && state.adminUploadState.selectedCategory ? `
                            <div>
                                <h3 class="text-lg font-bold text-white mb-3">تصاویر فعلی</h3>
                                <div class="mb-4 flex flex-wrap gap-2">
                                    ${(() => {
                        const fabricName = getFabricNameById(state.adminUploadState.selectedFabric.id);
                        const key = `${fabricName}_${state.adminUploadState.selectedCategory}`;
                        const images = GALLERY_IMAGES[key] || [];
                        return images.length > 0 ?
                            images.map((imgData, index) => `
                                                <div class="relative">
                                                    ${imgData.tags?.length > 0 ? `
                                                        <div class="image-tag-badge" onclick="openTagEditor('${imgData.url}')">
                                                            <i data-lucide="tag" class="w-3 h-3"></i>
                                                        </div>
                                                    ` : ''}
                                                    <img src="${imgData.url}"
                                                         alt="Image ${index + 1}"
                                                         class="preview-image"
                                                         onclick="openImageInNewTab('${imgData.url}')">
                                                </div>
                                            `).join('') :
                            `<p class="text-gray-300 col-span-full text-center py-4">هنوز تصویری آپلود نشده است</p>`;
                    })()}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                   
                    <!-- Action Buttons -->
                    <div class="flex justify-between">
                        <button onclick="navigateTo('admin')"
                                class="px-6 py-3 border-2 border-reyhan-gold/50 text-reyhan-gold rounded-lg font-bold hover:bg-reyhan-gold/10 transition-all backdrop-blur-sm">
                            بازگشت به پنل
                        </button>
                       
                        ${state.adminUploadState.uploadedImages.length > 0 ? `
                            <button onclick="saveUploadedImages()"
                                    class="px-6 py-3 btn-gold rounded-lg font-bold">
                                ذخیره تصاویر (${state.adminUploadState.uploadedImages.length})
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            return el;
        }

        // Tag management for upload
        window.addUploadTag = () => {
            const input = document.getElementById('uploadTagInput');
            if (input && input.value.trim()) {
                const tag = input.value.trim();
                if (!state.adminUploadState.tags) {
                    state.adminUploadState.tags = [];
                }
                if (!state.adminUploadState.tags.includes(tag)) {
                    state.adminUploadState.tags.push(tag);
                    input.value = '';
                    render();
                }
            }
        };

        window.addExistingTagToUpload = (tag) => {
            if (!state.adminUploadState.tags) {
                state.adminUploadState.tags = [];
            }
            if (!state.adminUploadState.tags.includes(tag)) {
                state.adminUploadState.tags.push(tag);
                render();
            }
        };

        window.removeUploadTag = (tag) => {
            if (state.adminUploadState.tags) {
                const index = state.adminUploadState.tags.indexOf(tag);
                if (index > -1) {
                    state.adminUploadState.tags.splice(index, 1);
                    render();
                }
            }
        };

        window.selectFabricForUpload = (fabricId) => {
            state.adminUploadState.selectedFabric = FABRICS.find(f => f.id === fabricId);
            state.adminUploadState.selectedCategory = null;
            state.adminUploadState.uploadedImages = [];
            state.adminUploadState.tags = [];
            render();
        };

        window.selectCategoryForUpload = (categoryId) => {
            state.adminUploadState.selectedCategory = categoryId;
            state.adminUploadState.uploadedImages = [];
            render();
        };

        window.handleDragOver = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) uploadArea.classList.add('dragover');
        };

        window.handleDragLeave = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) uploadArea.classList.remove('dragover');
        };

        window.handleDrop = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) uploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            handleImageUploadWithTags(files);
        };

        window.handleFileSelect = (e) => {
            const files = e.target.files;
            handleImageUploadWithTags(files);
        };

        function handleImageUploadWithTags(files) {
            const fabricId = state.adminUploadState.selectedFabric.id;
            const categoryId = state.adminUploadState.selectedCategory;
            const tags = state.adminUploadState.tags || [];

            const fabricName = getFabricNameById(fabricId);
            const key = `${fabricName}_${categoryId}`;

            if (!GALLERY_IMAGES[key]) {
                GALLERY_IMAGES[key] = [];
            }

            const categoryLabel = CATEGORIES.find(c => c.id === categoryId)?.label || categoryId;

            Array.from(files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        const imageUrl = e.target.result;
                        const imageData = {
                            url: imageUrl,
                            tags: [...tags] // Copy tags array
                        };

                        GALLERY_IMAGES[key].push(imageData);

                        // Add to tags database
                        tags.forEach(tag => {
                            addTagToImage(imageUrl, tag);
                        });

                        if (index === files.length - 1) {
                            saveImagesToStorage();
                            saveTagsToStorage();
                            showNotification(`${files.length} تصویر ${categoryLabel} با تگ‌ها اضافه شد`, 'success');

                            // Reset upload state
                            state.adminUploadState.uploadedImages = [];
                            state.adminUploadState.tags = [];

                            // Refresh view
                            if (state.view === 'admin' || state.view === 'imageUpload' || state.view === 'tagManager') {
                                render();
                            }
                        }
                    };

                    reader.readAsDataURL(file);
                }
            });
        }

        window.saveUploadedImages = () => {
            saveImagesToStorage();
            saveTagsToStorage();
            showNotification('تصاویر با موفقیت ذخیره شدند', 'success');
            state.adminUploadState.uploadedImages = [];
            state.adminUploadState.tags = [];
            setTimeout(() => navigateTo('admin'), 1000);
        };

        window.openImageUpload = () => {
            state.adminUploadState = {
                selectedFabric: null,
                selectedCategory: null,
                uploadedImages: [],
                tags: []
            };
            navigateTo('imageUpload');
        };

        // Admin Functions
        window.changeLogo = () => {
            const newLogoUrl = prompt('لطفا لینک تصویر جدید لوگو را وارد کنید:', CONFIG.logoImage);
            if (newLogoUrl && newLogoUrl.trim() !== '') {
                try {
                    new URL(newLogoUrl);
                    CONFIG.logoImage = newLogoUrl.trim();
                    localStorage.setItem('reyhantex_logo', newLogoUrl.trim());
                    showNotification('لوگو با موفقیت تغییر کرد', 'success');
                    render();
                } catch (e) {
                    showNotification('لینک وارد شده معتبر نیست', 'error');
                }
            }
        };

        window.manageFabricImages = () => {
            const fabricList = FABRICS.map(f => `${f.id}. ${f.name}`).join('\n');
            const fabricId = prompt(`لطفا شماره پارچه را برای ویرایش تصاویر انتخاب کنید:\n${fabricList}`);

            if (!fabricId) return;

            const fabric = FABRICS.find(f => f.id === parseInt(fabricId));
            if (!fabric) {
                showNotification('شماره پارچه نامعتبر است', 'error');
                return;
            }

            const currentMale = fabric.categoryImages.male;
            const currentFemale = fabric.categoryImages.female;
            const currentChild = fabric.categoryImages.children;

            const newMale = prompt(`لینک تصویر جدید برای آقایان (${fabric.name}):`, currentMale);
            const newFemale = prompt(`لینک تصویر جدید برای بانوان (${fabric.name}):`, currentFemale);
            const newChild = prompt(`لینک تصویر جدید برای کودکان (${fabric.name}):`, currentChild);

            if (newMale) {
                try {
                    new URL(newMale);
                    fabric.categoryImages.male = newMale;
                } catch (e) {
                    showNotification('لینک تصویر آقایان نامعتبر است', 'error');
                }
            }

            if (newFemale) {
                try {
                    new URL(newFemale);
                    fabric.categoryImages.female = newFemale;
                } catch (e) {
                    showNotification('لینک تصویر بانوان نامعتبر است', 'error');
                }
            }

            if (newChild) {
                try {
                    new URL(newChild);
                    fabric.categoryImages.children = newChild;
                } catch (e) {
                    showNotification('لینک تصویر کودکان نامعتبر است', 'error');
                }
            }

            localStorage.setItem('reyhantex_fabric_images', JSON.stringify(FABRICS));
            showNotification('تصاویر پارچه با موفقیت به‌روزرسانی شد', 'success');
            render();
        };

        window.exportToExcel = () => {
            const customers = db.getAllCustomers();
            if (customers.length === 0) {
                showNotification('داده‌ای برای خروجی وجود ندارد', 'warning');
                return;
            }

            try {
                const data = customers.map(c => ({
                    'تاریخ': new Date(c.timestamp).toLocaleString('fa-IR'),
                    'نام': c.name,
                    'تلفن': c.phone,
                    'اینستاگرام': c.instagram || '-',
                    'پارچه': c.fabric,
                    'دسته بندی': c.category ? CATEGORIES.find(cat => cat.id === c.category)?.label : '-'
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "مشتریان");

                const date = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `reyhantex_customers_${date}.xlsx`);

                showNotification('فایل Excel با موفقیت تولید شد', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('خطا در تولید فایل', 'error');
            }
        };

        window.clearDatabase = () => {
            if (confirm('آیا مطمئن هستید که می‌خواهید تمام داده‌ها را پاک کنید؟')) {
                db.clearAll();
                showNotification('همه داده‌ها پاک شدند', 'success');
                setTimeout(() => render(), 1000);
            }
        };

        window.goBackToLanding = () => {
            state.userData = { name: '', phone: '', instagram: '' };
            state.selectedFabric = null;
            state.selectedCategory = null;
            navigateTo('landing');
        };

        window.finishOrder = () => {
            showNotification('سفارش شما با موفقیت ثبت شد!', 'success');

            const successOverlay = document.createElement('div');
            successOverlay.className = 'fixed inset-0 z-50 bg-reyhan-green/95 flex flex-col items-center justify-center animate-fade-in';
            successOverlay.innerHTML = `
                <div class="text-center">
                    <div class="w-32 h-32 bg-gradient-to-br from-reyhan-gold to-yellow-200 rounded-full flex items-center justify-center mx-auto mb-8 animate-float">
                        <i data-lucide="check" class="w-16 h-16 text-reyhan-dark"></i>
                    </div>
                    <h2 class="text-4xl font-black text-white mb-4">با تشکر از شما</h2>
                    <p class="text-reyhan-gold text-lg">سفارش شما ثبت و به واحد فروش ارسال شد</p>
                </div>
            `;
            document.body.appendChild(successOverlay);
            lucide.createIcons();

            setTimeout(() => {
                successOverlay.remove();
                goBackToLanding();
            }, 2500);
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved images from localStorage
            loadImagesFromStorage();
            loadTagsFromStorage();
            initializeTags();

            // Load saved fabric images
            const savedFabricImages = localStorage.getItem('reyhantex_fabric_images');
            if (savedFabricImages) {
                try {
                    const parsed = JSON.parse(savedFabricImages);
                    parsed.forEach(savedFabric => {
                        const fabric = FABRICS.find(f => f.id === savedFabric.id);
                        if (fabric && savedFabric.categoryImages) {
                            fabric.categoryImages = savedFabric.categoryImages;
                        }
                    });
                } catch (e) {
                    console.error('Error loading saved fabric images:', e);
                }
            }

            render();

            // Add sample data if empty
            if (db.getAllCustomers().length === 0) {
                db.addCustomer({
                    name: 'احمد محمدی',
                    phone: '09121234567',
                    instagram: 'ahmad',
                    fabric: 'ریحانا',
                    category: 'male'
                });
                db.addCustomer({
                    name: 'فاطمه کریمی',
                    phone: '09129876543',
                    instagram: 'fatemeh',
                    fabric: 'پفکی (ینزی)',
                    category: 'female'
                });
            }
        });
    </script>
</body>

</html>